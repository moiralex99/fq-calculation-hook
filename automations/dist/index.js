function t({evaluator:t,logger:a,executors:n={}}){return{async evaluate({collection:r,automations:o,newData:i,oldData:s,context:l}){const c={},u=Object.keys(i||{}).filter(t=>!s||i[t]!==s[t]);for(const y of o)try{if(y.collection_cible){const t=y.collection_cible;if(!(Array.isArray(t)?t.includes(r):t===r))continue}if(y.status&&"active"!==y.status)continue;const o=y.rule||y.rule_jsonb||y.trigger;if(!o)continue;const f={...{...s||{},...i||{}},$OLD:s||{},$CHANGED:u,$USER:l?.$USER||null,$AUTOMATION:{id:y.id,name:y.name,throttle_ms:y.throttle_ms,throttle_scope:y.throttle_scope}},d=await t.evaluateRule(o,f);if(a?.info(`[Automations] rule ${y.name||y.id||""} match=${d} changed=[${u.join(", ")}]`),!d)continue;const p=Array.isArray(y.actions)?y.actions:[];await e(p,{newData:i,oldData:s,context:f,updates:c,evaluator:t,logger:a,executors:n})}catch(t){a?.error("[Automations] Rule failed:",y?.name||y?.id,t?.message||t)}return c}}}async function e(t,{newData:r,oldData:o,context:i,updates:s,evaluator:l,logger:c,executors:u}){for(const y of t){if(Object.prototype.hasOwnProperty.call(y,"when"))try{if(!await l.evaluateRule(y.when,i)){c?.info(`[Automations] action ${y.type} skipped by when`);continue}}catch{c?.info(`[Automations] action ${y.type} skipped (when evaluation error)`);continue}if("set_field"===y.type&&y.field){const t=await a(y.value,{newData:r,oldData:o,context:i},l);void 0!==t?(c?.info(`[Automations] action set_field ${y.field} = ${JSON.stringify(t)}`),s[y.field]=t):c?.info(`[Automations] action set_field ${y.field} skipped (undefined)`)}else if("for_each"===y.type){const t=await a(y.list,{newData:r,oldData:o,context:i},l),n=Array.isArray(t)?t:[];c?.info(`[Automations] action for_each iterating over ${n.length} items`);for(let t=0;t<n.length;t++){const a=n[t],f={...i,$item:a,$index:t,$parent:i.$item||null},d=Array.isArray(y.actions)?y.actions:[];await e(d,{newData:r,oldData:o,context:f,updates:s,evaluator:l,logger:c,executors:u})}}else if("trigger_flow"===y.type&&u.trigger_flow){const t=y.key||y.flow_key||y.flow,e=await n(y.payload||{},{newData:r,oldData:o,context:i},l);c?.info(`[Automations] action trigger_flow key=${t} payload=${JSON.stringify(e)}`);try{await u.trigger_flow({key:t,payload:e,context:i})}catch(t){c?.error("[Automations] trigger_flow failed",t?.message||t)}}else if("create_item"===y.type&&u.create_item){const t=await n(y.data||{},{newData:r,oldData:o,context:i},l),e=y.collection;c?.info(`[Automations] action create_item in ${e} data=${JSON.stringify(t)}`);try{const a=await u.create_item({collection:e,data:t,context:i});y.assign&&a&&(i[`$${y.assign}`]=a,c?.info(`[Automations] assigned $${y.assign} = ${a.id||a}`))}catch(t){c?.error("[Automations] create_item failed",t?.message||t)}}else if("update_item"===y.type&&u.update_item){const t=await n(y.data||{},{newData:r,oldData:o,context:i},l),e=await a(y.id,{newData:r,oldData:o,context:i},l),s=y.collection;c?.info(`[Automations] action update_item in ${s} id=${e} data=${JSON.stringify(t)}`);try{const a=await u.update_item({collection:s,id:e,data:t,context:i});y.assign&&a&&(i[`$${y.assign}`]=a,c?.info(`[Automations] assigned $${y.assign} = ${a.id||a}`))}catch(t){c?.error("[Automations] update_item failed",t?.message||t)}}else if("send_email"===y.type&&u.send_email){const t=await a(y.to,{newData:r,oldData:o,context:i},l),e=await a(y.subject,{newData:r,oldData:o,context:i},l),n=await a(y.body,{newData:r,oldData:o,context:i},l);c?.info(`[Automations] action send_email to=${JSON.stringify(t)} subject=${JSON.stringify(e)}`);try{await u.send_email({to:t,subject:e,body:n,context:i})}catch(t){c?.error("[Automations] send_email failed",t?.message||t)}}else if("update_many"===y.type&&u.update_many){const t=await n(y.data||{},{newData:r,oldData:o,context:i},l),e=await n(y.filter||{},{newData:r,oldData:o,context:i},l),s=await a(y.limit,{newData:r,oldData:o,context:i},l),f=y.collection;c?.info(`[Automations] action update_many in ${f} filter=${JSON.stringify(e)} data=${JSON.stringify(t)} limit=${JSON.stringify(s)}`);try{const a=await u.update_many({collection:f,filter:e,data:t,limit:s,context:i});y.assign&&a&&(i[`$${y.assign}`]=a,c?.info(`[Automations] assigned $${y.assign} = ${JSON.stringify(a)}`))}catch(t){c?.error("[Automations] update_many failed",t?.message||t)}}}}async function a(t,{newData:e,oldData:a,context:n},r){if("NOW()"===t)return(new Date).toISOString();if("$USER.id"===t)return n?.$USER?.id??null;if(o(t))try{return await r.evaluateValue(t,n)}catch{return}return"string"==typeof t||"number"==typeof t||"boolean"==typeof t||null==t?t:null}async function n(t,{newData:e,oldData:r,context:i},s){if(Array.isArray(t)){const a=[];for(const o of t)a.push(await n(o,{newData:e,oldData:r,context:i},s));return a}if(t&&"object"==typeof t){if(o(t)){const n=await a(t,{newData:e,oldData:r,context:i},s);if((t=>void 0!==t&&(null===t||["string","number","boolean"].includes(typeof t)||Array.isArray(t)))(n))return n}const l={};for(const[a,o]of Object.entries(t))l[a]=await n(o,{newData:e,oldData:r,context:i},s);return l}return await a(t,{newData:e,oldData:r,context:i},s)}const r=new Set(["var","if","and","or","!","!!","===","==","!=",">",">=","<","<=","+","-","*","/","%","in","cat","now","date_diff","date_add","concat","matches","imatches","iif","case","get","coalesce","length","map_by","filter_by","reduce_by","sum_by","any_by","all_by","lookup","lookup_many","changed_to","__ctx"]);function o(t){if(!t||"object"!=typeof t||Array.isArray(t))return!1;const e=Object.keys(t);return 1===e.length&&r.has(e[0])}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function i(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var s={exports:{}};s.exports=function(){function t(t){for(var e=[],a=0,n=t.length;a<n;a++)-1===e.indexOf(t[a])&&e.push(t[a]);return e}Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)});var e={},a={"==":function(t,e){return t==e},"===":function(t,e){return t===e},"!=":function(t,e){return t!=e},"!==":function(t,e){return t!==e},">":function(t,e){return t>e},">=":function(t,e){return t>=e},"<":function(t,e,a){return void 0===a?t<e:t<e&&e<a},"<=":function(t,e,a){return void 0===a?t<=e:t<=e&&e<=a},"!!":function(t){return e.truthy(t)},"!":function(t){return!e.truthy(t)},"%":function(t,e){return t%e},log:function(t){return console.log(t),t},in:function(t,e){return!(!e||void 0===e.indexOf)&&-1!==e.indexOf(t)},cat:function(){return Array.prototype.join.call(arguments,"")},substr:function(t,e,a){if(a<0){var n=String(t).substr(e);return n.substr(0,n.length+a)}return String(t).substr(e,a)},"+":function(){return Array.prototype.reduce.call(arguments,function(t,e){return parseFloat(t,10)+parseFloat(e,10)},0)},"*":function(){return Array.prototype.reduce.call(arguments,function(t,e){return parseFloat(t,10)*parseFloat(e,10)})},"-":function(t,e){return void 0===e?-t:t-e},"/":function(t,e){return t/e},min:function(){return Math.min.apply(this,arguments)},max:function(){return Math.max.apply(this,arguments)},merge:function(){return Array.prototype.reduce.call(arguments,function(t,e){return t.concat(e)},[])},var:function(t,e){var a=void 0===e?null:e,n=this;if(void 0===t||""===t||null===t)return n;for(var r=String(t).split("."),o=0;o<r.length;o++){if(null==n)return a;if(void 0===(n=n[r[o]]))return a}return n},missing:function(){for(var t=[],a=Array.isArray(arguments[0])?arguments[0]:arguments,n=0;n<a.length;n++){var r=a[n],o=e.apply({var:r},this);null!==o&&""!==o||t.push(r)}return t},missing_some:function(t,a){var n=e.apply({missing:a},this);return a.length-n.length>=t?[]:n}};return e.is_logic=function(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)&&1===Object.keys(t).length},e.truthy=function(t){return!(Array.isArray(t)&&0===t.length||!t)},e.get_operator=function(t){return Object.keys(t)[0]},e.get_values=function(t){return t[e.get_operator(t)]},e.apply=function(t,n){if(Array.isArray(t))return t.map(function(t){return e.apply(t,n)});if(!e.is_logic(t))return t;var r,o,i,s,l,c=e.get_operator(t),u=t[c];if(Array.isArray(u)||(u=[u]),"if"===c||"?:"==c){for(r=0;r<u.length-1;r+=2)if(e.truthy(e.apply(u[r],n)))return e.apply(u[r+1],n);return u.length===r+1?e.apply(u[r],n):null}if("and"===c){for(r=0;r<u.length;r+=1)if(o=e.apply(u[r],n),!e.truthy(o))return o;return o}if("or"===c){for(r=0;r<u.length;r+=1)if(o=e.apply(u[r],n),e.truthy(o))return o;return o}if("filter"===c)return s=e.apply(u[0],n),i=u[1],Array.isArray(s)?s.filter(function(t){return e.truthy(e.apply(i,t))}):[];if("map"===c)return s=e.apply(u[0],n),i=u[1],Array.isArray(s)?s.map(function(t){return e.apply(i,t)}):[];if("reduce"===c)return s=e.apply(u[0],n),i=u[1],l=void 0!==u[2]?e.apply(u[2],n):null,Array.isArray(s)?s.reduce(function(t,a){return e.apply(i,{current:a,accumulator:t})},l):l;if("all"===c){if(s=e.apply(u[0],n),i=u[1],!Array.isArray(s)||!s.length)return!1;for(r=0;r<s.length;r+=1)if(!e.truthy(e.apply(i,s[r])))return!1;return!0}if("none"===c){if(s=e.apply(u[0],n),i=u[1],!Array.isArray(s)||!s.length)return!0;for(r=0;r<s.length;r+=1)if(e.truthy(e.apply(i,s[r])))return!1;return!0}if("some"===c){if(s=e.apply(u[0],n),i=u[1],!Array.isArray(s)||!s.length)return!1;for(r=0;r<s.length;r+=1)if(e.truthy(e.apply(i,s[r])))return!0;return!1}if(u=u.map(function(t){return e.apply(t,n)}),a.hasOwnProperty(c)&&"function"==typeof a[c])return a[c].apply(n,u);if(c.indexOf(".")>0){var y=String(c).split("."),f=a;for(r=0;r<y.length;r++){if(!f.hasOwnProperty(y[r]))throw new Error("Unrecognized operation "+c+" (failed at "+y.slice(0,r+1).join(".")+")");f=f[y[r]]}return f.apply(n,u)}throw new Error("Unrecognized operation "+c)},e.uses_data=function(a){var n=[];if(e.is_logic(a)){var r=e.get_operator(a),o=a[r];Array.isArray(o)||(o=[o]),"var"===r?n.push(o[0]):o.forEach(function(t){n.push.apply(n,e.uses_data(t))})}return t(n)},e.add_operation=function(t,e){a[t]=e},e.rm_operation=function(t){delete a[t]},e.rule_like=function(t,a){if(a===t)return!0;if("@"===a)return!0;if("number"===a)return"number"==typeof t;if("string"===a)return"string"==typeof t;if("array"===a)return Array.isArray(t)&&!e.is_logic(t);if(e.is_logic(a)){if(e.is_logic(t)){var n=e.get_operator(a),r=e.get_operator(t);if("@"===n||n===r)return e.rule_like(e.get_values(t,!1),e.get_values(a,!1))}return!1}if(Array.isArray(a)){if(Array.isArray(t)){if(a.length!==t.length)return!1;for(var o=0;o<a.length;o+=1)if(!e.rule_like(t[o],a[o]))return!1;return!0}return!1}return!1},e}();var l=i(s.exports);function c(t={}){function e(t){return Array.isArray(t)?t:[]}function a(t,e){try{if(t&&"object"==typeof t&&!Array.isArray(t))return l.apply(t,e);if("string"==typeof t){const a=t.split(".");let n=e.it;for(const t of a)n=n?.[t];return n}return t}catch{return}}l.add_operation("now",()=>(new Date).toISOString()),l.add_operation("date_diff",(t,e,a="days")=>{const n=new Date(t)-new Date(e);if(!Number.isFinite(n))return 0;const r="hours"===a?36e5:"minutes"===a?6e4:864e5;return Math.floor(n/r)}),l.add_operation("date_add",(t,e,a="days")=>{const n=new Date(t);return Number.isFinite(e)&&("minutes"===a?n.setMinutes(n.getMinutes()+e):"hours"===a?n.setHours(n.getHours()+e):n.setDate(n.getDate()+e)),n.toISOString()}),l.add_operation("concat",(...t)=>t.filter(t=>null!=t).join("")),l.add_operation("matches",(t,e,a="")=>{try{const n=String(a??"").replace(/[^gimsuy]/g,"");return new RegExp(e??"",n).test(String(t??""))}catch{return!1}}),l.add_operation("imatches",(t,e)=>{try{return new RegExp(e??"","i").test(String(t??""))}catch{return!1}}),l.add_operation("iif",(t,e,a)=>t?e:a),l.add_operation("case",(...t)=>{for(let e=0;e<t.length-1;e+=2)if(t[e])return t[e+1];return t.length%2==1?t[t.length-1]:null}),l.add_operation("get",(t,e,a=null)=>{if(null==t||null==e)return a;const n=Array.isArray(e)?e:String(e).split(".");let r=t;for(const t of n){if(null==r)return a;r=r[t]}return null==r?a:r}),l.add_operation("coalesce",(...t)=>{for(const e of t)if(null!=e)return e;return null}),l.add_operation("length",t=>null==t?0:Array.isArray(t)?t.length:"object"==typeof t?Object.keys(t).length:String(t).length),l.add_operation("map_by",(t,n,r)=>{try{return e(t).map(t=>a(n,{...r||{},it:t}))}catch{return[]}}),l.add_operation("filter_by",(t,n,r)=>{try{return e(t).filter(t=>!!a(n,{...r||{},it:t}))}catch{return[]}}),l.add_operation("reduce_by",(t,n,r,o)=>{try{return e(t).reduce((t,e)=>a(r,{...o||{},acc:t,it:e}),n)}catch{return n}}),l.add_operation("sum_by",(t,n,r)=>{try{return e(t).reduce((t,e)=>t+Number(a(n,{...r||{},it:e})||0),0)}catch{return 0}}),l.add_operation("any_by",(t,n,r)=>{try{return e(t).some(t=>!!a(n,{...r||{},it:t}))}catch{return!1}}),l.add_operation("all_by",(t,n,r)=>{try{return e(t).every(t=>!!a(n,{...r||{},it:t}))}catch{return!1}});const n=t.getItem,r=t.listItems;function o(t,e){if(t&&"object"==typeof t){if(1===Object.keys(t).length&&Object.prototype.hasOwnProperty.call(t,"var"))try{return l.apply(t,e)}catch{return null}if(Array.isArray(t))return t.map(t=>o(t,e));const a={};for(const[n,r]of Object.entries(t))a[n]=o(r,e);return a}return t}return l.add_operation("lookup",async(t,e,a=["*"],r)=>{try{return n?await n(t,e,o(a,r)):null}catch{return null}}),l.add_operation("lookup_many",async(t,e={},a=["*"],n=50,i)=>{try{if(!r)return[];const s=o(e,i)||{},l=o(a,i)||["*"],c=Number.isFinite(n)?n:50;return await r(t,s,l,c)}catch{return[]}}),l.add_operation("changed_to",(t,e,a,n)=>{try{return!!(Array.isArray(a)&&a.includes(t))&&l.apply({"===":[{var:t},e]},n)}catch{return!1}}),{evaluateRule:async function(t,e){try{l.add_operation("__ctx",()=>e);return!!await l.apply(t,e)}catch{return!1}},evaluateValue:async function(t,e){try{return l.add_operation("__ctx",()=>e),await l.apply(t,e)}catch{return null}}}}function u(t){if(null==t)return null;if("object"==typeof t)return t;if("string"==typeof t)try{return JSON.parse(t)}catch{return t}return t}function y(t){let e=t.rule??t.rule_jsonb??t.trigger??null;e=u(e);let a=t.actions??t.actions_jsonb??[];a=u(a),a&&!Array.isArray(a)&&(a=a.type?[a]:[]);let n=t.collection_cible;return n=u(n),{...t,rule:e,actions:a,collection_cible:n}}function f(t,e){const a=t.collection_cible;return!a||(Array.isArray(a)?a.includes(e):a===e)}function d(t,e){return t.filter(t=>{let a,n=t.trigger_event;if(n||(n=["update"]),Array.isArray(n))a=n;else if("string"==typeof n){if("*"===n)return!0;a=n.split(",").map(t=>t.trim())}else a=["update"];return a.includes("*")||a.includes(e)})}const p=[{name:"quartz-automations-hook",config:({action:e,filter:a},{services:n,database:r,logger:o,getSchema:i})=>{const{ItemsService:s}=n,l=c({getItem:async(t,e,a=["*"])=>{const n=await i();return new s(t,{database:r,schema:n}).readOne(e,{fields:a})},listItems:async(t,e={},a=["*"],n=50)=>{const o=await i(),l=new s(t,{database:r,schema:o}),c=await l.readByQuery({filter:e,fields:a,limit:n});return Array.isArray(c)?c:c?.data||[]}});let u=[],p=null;const m=new Map;function g({rule:t,collection:e,meta:a,scope:n}){const r=["auto",String(t.id??t.name??"unknown")];return"collection"===n?r.push(String(e)):"item"===n?r.push(String(a?.keys?.[0]??"unknown")):"user"===n&&r.push(String(a?.accountability?.user??"anon")),r.join("::")}async function h(){try{const t=new s("quartz_automations",{database:r,schema:await i()}),e=await t.readByQuery({limit:-1,sort:["priority"],fields:["id","name","status","collection_cible","rule","rule_jsonb","actions","actions_jsonb","priority","expand_fields","trigger_event","throttle_ms","throttle_scope"],filter:{status:{_eq:"active"}}}),a=Array.isArray(e)?e:e?.data||[];u=function(t){return(t||[]).map(y)}(a),o.info(`[Automations] 📋 Loaded ${u.length} active rules (normalized)`);for(const t of u){const e=Array.isArray(t.actions)?t.actions.length:0,a=Array.isArray(t.collection_cible)?t.collection_cible.join(","):t.collection_cible||"any";o.info(`[Automations]   - "${t.name||t.id}" on ${a} with ${e} actions`),0===e&&o.warn(`[Automations] ⚠️ Rule '${t.name||t.id}' has no actions after normalization`)}return!0}catch(t){return o.warn(`[Automations] Can't load rules (table missing yet?) → ${t?.message||t}`),u=[],!1}}function _(){const t=u.map(t=>`${t.id}:${t.name}:${JSON.stringify(t.rule)}:${JSON.stringify(t.actions)}`).join("|");let e=0;for(let a=0;a<t.length;a++){e=(e<<5)-e+t.charCodeAt(a),e&=e}return e.toString(16)}const A=t({evaluator:l,logger:o,executors:{async create_item({collection:t,data:e,context:a}){if(!t)throw new Error("create_item requires collection");const n=await i(),o=new s(t,{database:r,schema:n}),l={user:a?.$USER?.id,_automationTriggered:!0};return await o.createOne(e,{accountability:l})},async update_item({collection:t,id:e,data:a,context:n}){if(!t)throw new Error("update_item requires collection");if(!e)throw new Error("update_item requires id");const o=await i(),l=new s(t,{database:r,schema:o}),c={user:n?.$USER?.id,_automationTriggered:!0};return await l.updateOne(e,a,{accountability:c})},async update_many({collection:t,filter:e={},data:a={},limit:n=-1,context:l}){if(!t)throw new Error("update_many requires collection");const c=await i(),u=new s(t,{database:r,schema:c}),y={user:l?.$USER?.id,_automationTriggered:!0};try{if("function"==typeof u.updateByQuery){const t={filter:e,limit:n},r=await u.updateByQuery(t,a,{accountability:y});return{count:Array.isArray(r)?r.length:r?.length??null}}}catch(e){o.warn(`[Automations] updateByQuery failed on ${t}: ${e?.message||e}`)}const f=(c.collections?.[t]||{}).primary||"id",d=await u.readByQuery({filter:e,limit:n,fields:[f]}),p=(Array.isArray(d)?d:d?.data||[]).map(t=>t?.[f]).filter(t=>null!=t);return 0===p.length?{count:0}:(await u.updateMany(p,a,{accountability:y}),{count:p.length})},async trigger_flow({key:t,payload:a,context:n}){await e("automations.trigger.flow",{key:t,payload:a,user:n?.$USER?.id})},async send_email({to:t,subject:e,body:a,context:n}){o.info(`[Automations] (stub) send_email to=${t} subject=${e}`)}}});function w(t=""){p&&clearTimeout(p),p=setTimeout(async()=>{o.info(`[Automations] 🔄 Auto-reloading automations (reason: ${t})...`);const e=await async function({attempts:t=3,settleDelayMs:e=700,reason:a="unknown"}={}){let n=null;for(let r=1;r<=t;r++){await h();const i=_();if(o.debug(`[Automations] Reload attempt ${r}/${t} (reason: ${a}) signature: ${i}`),n&&i===n)return o.info(`[Automations] 🔒 Reload stabilized on attempt ${r} (reason: ${a})`),!0;n=i,r<t&&await new Promise(t=>setTimeout(t,e))}return o.info(`[Automations] ✅ Reload completed after ${t} attempts (reason: ${a})`),!0}({attempts:3,settleDelayMs:700,reason:t});if(e){const t=u.map(t=>{const e=Array.isArray(t.trigger_event)?t.trigger_event.join(","):t.trigger_event||"update";return`${t.name}[${e}]`}).join(", ");o.info(`[Automations] 🎯 Active automations: ${t}`)}else o.warn("[Automations] ⚠️ Reload had issues");p=null},300)}h(),e("automations.reload",async()=>(await h(),{success:!0,count:u.length})),e("items.create",async(t,e)=>{"quartz_automations"===e?.collection&&(o.info("[Automations] 🆕 Detected create on quartz_automations"),w("create"))}),e("items.update",async(t,e)=>{"quartz_automations"===e?.collection&&(o.info("[Automations] ✏️ Detected update on quartz_automations"),w("update"))}),e("items.delete",async(t,e)=>{"quartz_automations"===e?.collection&&(o.info("[Automations] 🗑️ Detected delete on quartz_automations"),w("delete"))}),a("items.update",async(t,e)=>{try{if("quartz_automations"===e?.collection)return o.info("[Automations] ✏️ Detected update on quartz_automations (via filter), scheduling reload"),w("items.update on quartz_automations"),t;const a=d(u,"update").filter(t=>f(t,e.collection));if(0===a.length)return t;const n=await i(),l=new s(e.collection,{database:r,schema:n}),c=function(t,e){const a=new Set;for(const n of t){if(!f(n,e))continue;const t=Array.isArray(n.expand_fields)?n.expand_fields:[];for(const e of t)"string"==typeof e&&a.add(e)}return Array.from(a)}(a,e.collection),y=await l.readOne(e.keys?.[0],c.length?{fields:c}:void 0),p=Object.keys(t||{}).filter(e=>!y||t[e]!==y[e]);o.info(`[Automations] items.update on ${e.collection} id=${e.keys?.[0]} changed=[${p.join(", ")}] rules=${a.length}`);const h={},_=[];for(const n of a){const a=Number(n.throttle_ms)||0,r=n.throttle_scope||"rule";if(a>0){const i=g({rule:n,collection:e.collection,meta:e,scope:r});m.has(i)&&clearTimeout(m.get(i).timer);const s=m.get(i)||{lastPayload:null,lastOriginal:null};s.lastPayload=t,s.lastOriginal=y;const l=setTimeout(async()=>{try{const t=await A.evaluate({collection:e.collection,automations:[n],newData:s.lastPayload,oldData:s.lastOriginal,context:{$USER:e?.accountability?.user}});Object.assign(h,t)}catch(t){o.error("[Automations] throttled evaluate failed",t?.message||t)}m.delete(i)},a);m.set(i,{...s,timer:l})}else _.push(A.evaluate({collection:e.collection,automations:[n],newData:t,oldData:y,context:{$USER:e?.accountability?.user}}).then(t=>Object.assign(h,t)).catch(t=>o.error("[Automations] evaluate failed",t?.message||t)))}return await Promise.all(_),Object.keys(h).length>0?o.info(`[Automations] updates computed → ${JSON.stringify(h)}`):o.info("[Automations] no updates computed"),{...t,...h}}catch(e){return o.error("[Automations] Error in items.update:",e?.message||e),t}}),a("items.create",async(t,e)=>{try{if("quartz_automations"===e?.collection)return o.info("[Automations] 🆕 Detected create on quartz_automations (via filter), scheduling reload"),w("items.create on quartz_automations"),t;const a=d(u,"create").filter(t=>f(t,e.collection));if(0===a.length)return t;if(e?.accountability?._automationTriggered)return o.info(`[Automations] items.create on ${e.collection} SKIPPED (automation-triggered)`),t;o.info(`[Automations] items.create on ${e.collection} rules=${a.length}`);const n={},r=[];for(const i of a){const a=Number(i.throttle_ms)||0,s=i.throttle_scope||"rule";if(a>0){const r=g({rule:i,collection:e.collection,meta:e,scope:s});m.has(r)&&clearTimeout(m.get(r).timer);const l=m.get(r)||{lastPayload:null,lastOriginal:null};l.lastPayload=t,l.lastOriginal=null;const c=setTimeout(async()=>{try{const t=await A.evaluate({collection:e.collection,automations:[i],newData:l.lastPayload,oldData:l.lastOriginal,context:{$USER:e?.accountability?.user}});Object.assign(n,t)}catch(t){o.error("[Automations] throttled evaluate failed",t?.message||t)}m.delete(r)},a);m.set(r,{...l,timer:c})}else r.push(A.evaluate({collection:e.collection,automations:[i],newData:t,oldData:null,context:{$USER:e?.accountability?.user}}).then(t=>Object.assign(n,t)).catch(t=>o.error("[Automations] evaluate failed",t?.message||t)))}return await Promise.all(r),Object.keys(n).length>0?o.info(`[Automations] updates computed → ${JSON.stringify(n)}`):o.info("[Automations] no updates computed"),{...t,...n}}catch(e){return o.error("[Automations] Error in items.create:",e?.message||e),t}})}}],m=[{name:"quartz-automations",config:(e,{services:a,database:n,logger:r,getSchema:o})=>{const{ItemsService:i}=a;function s(){return c({getItem:async(t,e,a=["*"])=>{const r=await o();return new i(t,{database:n,schema:r}).readOne(e,{fields:a})},listItems:async(t,e={},a=["*"],r=50)=>{const s=await o(),l=new i(t,{database:n,schema:s}),c=await l.readByQuery({filter:e,fields:a,limit:r});return Array.isArray(c)?c:c?.data||[]}})}e.post("/dry-run",async(e,a)=>{try{const{draft:n,sampleItem:o={},oldItem:i=null,collection:l=null}=e.body||{};if(!n||"object"!=typeof n)return a.status(400).json({ok:!1,error:"Missing draft"});const c=s(),u=[],y={create_item:async({collection:t,data:e})=>(u.push({type:"create_item",collection:t,data:e}),{id:"dry-id"}),update_item:async({collection:t,id:e,data:a})=>(u.push({type:"update_item",collection:t,id:e,data:a}),{id:e}),update_many:async({collection:t,filter:e,data:a,limit:n})=>(u.push({type:"update_many",collection:t,filter:e,data:a,limit:n}),{count:0}),async trigger_flow({key:t,payload:e}){u.push({type:"trigger_flow",key:t,payload:e})},async send_email({to:t,subject:e}){u.push({type:"send_email",to:t,subject:e})}},f=t({evaluator:c,logger:r,executors:y}),d=Array.isArray(n)?n[0]:n,p={id:d.id,name:d.name||"draft",status:d.status||"active",collection_cible:d.collection_cible,rule:d.rule||d.rule_jsonb||d.trigger||{},actions:Array.isArray(d.actions)?d.actions:[],throttle_ms:d.throttle_ms,throttle_scope:d.throttle_scope};let m=l;if(m||("string"==typeof p.collection_cible?m=p.collection_cible:Array.isArray(p.collection_cible)&&p.collection_cible.length>0&&(m=p.collection_cible[0])),!m)return a.status(400).json({ok:!1,error:"Provide collection or collection_cible"});const g=await f.evaluate({collection:m,automations:[p],newData:o,oldData:i,context:{$USER:e?.accountability?.user}});a.json({ok:!0,updates:g,sideEffects:u})}catch(t){r.error("[Automations Endpoint] dry-run error:",t?.message||t),a.status(500).json({ok:!1,error:t?.message||String(t)})}}),e.post("/lint",async(t,e)=>{try{const{draft:a}=t.body||{},n=[];if(!a||"object"!=typeof a)return e.status(400).json({ok:!1,messages:[{level:"error",message:"Missing draft"}]});const r=s(),i=Array.isArray(a)?a[0]:a;try{const t={};await r.evaluateRule(i.rule||i.rule_jsonb||i.trigger||{},t),n.push({level:"info",message:"Rule JSON valid"})}catch(t){n.push({level:"error",message:"Rule invalid: "+(t?.message||t)})}const l=Array.isArray(i.actions)?i.actions:[],c=new Set(["set_field","create_item","update_item","update_many","for_each","trigger_flow","send_email"]);for(let t=0;t<l.length;t++){const e=l[t];if(e&&"object"==typeof e)if(e.type&&c.has(e.type)){if("when"in e)try{await r.evaluateRule(e.when,{})}catch(e){n.push({level:"warn",message:`Action[${t}].when invalid: ${e?.message||e}`})}"set_field"===e.type&&("field"in e||n.push({level:"error",message:`Action[${t}] set_field requires 'field'`})),"create_item"!==e.type&&"update_item"!==e.type&&"update_many"!==e.type||e.collection||n.push({level:"error",message:`Action[${t}] ${e.type} requires 'collection'`}),"update_item"===e.type&&("id"in e||n.push({level:"error",message:`Action[${t}] update_item requires 'id'`})),"for_each"===e.type&&("list"in e&&Array.isArray(e.actions)||n.push({level:"error",message:`Action[${t}] for_each requires 'list' and 'actions[]'`}))}else n.push({level:"error",message:`Action[${t}] unsupported type: ${e?.type}`});else n.push({level:"error",message:`Action[${t}] is not an object`})}try{const t=await o(),e=new Set(Object.keys(t.collections||{})),a=i.collection_cible,r=Array.isArray(a)?a:a?[a]:[];for(const t of r)e.has(t)||n.push({level:"warn",message:`Unknown collection_cible: ${t}`});for(const t of l)t?.collection&&!e.has(t.collection)&&n.push({level:"warn",message:`Unknown action collection: ${t.collection}`})}catch{}const u=n.every(t=>"error"!==t.level);e.json({ok:u,messages:n})}catch(t){r.error("[Automations Endpoint] lint error:",t?.message||t),e.status(500).json({ok:!1,messages:[{level:"error",message:t?.message||String(t)}]})}})}}],g=[];export{m as endpoints,p as hooks,g as operations};
