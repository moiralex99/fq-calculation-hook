async function t(a,{newData:r,oldData:o,context:i,updates:u,evaluator:s,logger:l,executors:c}){for(const f of a){if(f.when)try{if(!await s.evaluateRule(f.when,i)){l?.info(`[Automations] action ${f.type} skipped by when`);continue}}catch{l?.info(`[Automations] action ${f.type} skipped (when evaluation error)`);continue}if("set_field"===f.type&&f.field){const t=await e(f.value,{newData:r,oldData:o,context:i},s);void 0!==t?(l?.info(`[Automations] action set_field ${f.field} = ${JSON.stringify(t)}`),u[f.field]=t):l?.info(`[Automations] action set_field ${f.field} skipped (undefined)`)}else if("for_each"===f.type){const n=await e(f.list,{newData:r,oldData:o,context:i},s),a=Array.isArray(n)?n:[];l?.info(`[Automations] action for_each iterating over ${a.length} items`);for(let e=0;e<a.length;e++){const n=a[e],y={...i,$item:n,$index:e,$parent:i.$item||null},d=Array.isArray(f.actions)?f.actions:[];await t(d,{newData:r,oldData:o,context:y,updates:u,evaluator:s,logger:l,executors:c})}}else if("trigger_flow"===f.type&&c.trigger_flow){const t=f.key||f.flow_key||f.flow,e=await n(f.payload||{},{newData:r,oldData:o,context:i},s);l?.info(`[Automations] action trigger_flow key=${t} payload=${JSON.stringify(e)}`);try{await c.trigger_flow({key:t,payload:e,context:i})}catch(t){l?.error("[Automations] trigger_flow failed",t?.message||t)}}else if("create_item"===f.type&&c.create_item){const t=await n(f.data||{},{newData:r,oldData:o,context:i},s),e=f.collection;l?.info(`[Automations] action create_item in ${e} data=${JSON.stringify(t)}`);try{const n=await c.create_item({collection:e,data:t,context:i});f.assign&&n&&(i[`$${f.assign}`]=n,l?.info(`[Automations] assigned $${f.assign} = ${n.id||n}`))}catch(t){l?.error("[Automations] create_item failed",t?.message||t)}}else if("update_item"===f.type&&c.update_item){const t=await n(f.data||{},{newData:r,oldData:o,context:i},s),a=await e(f.id,{newData:r,oldData:o,context:i},s),u=f.collection;l?.info(`[Automations] action update_item in ${u} id=${a} data=${JSON.stringify(t)}`);try{const e=await c.update_item({collection:u,id:a,data:t,context:i});f.assign&&e&&(i[`$${f.assign}`]=e,l?.info(`[Automations] assigned $${f.assign} = ${e.id||e}`))}catch(t){l?.error("[Automations] update_item failed",t?.message||t)}}else if("send_email"===f.type&&c.send_email){const t=await e(f.to,{newData:r,oldData:o,context:i},s),n=await e(f.subject,{newData:r,oldData:o,context:i},s),a=await e(f.body,{newData:r,oldData:o,context:i},s);l?.info(`[Automations] action send_email to=${JSON.stringify(t)} subject=${JSON.stringify(n)}`);try{await c.send_email({to:t,subject:n,body:a,context:i})}catch(t){l?.error("[Automations] send_email failed",t?.message||t)}}else if("update_many"===f.type&&c.update_many){const t=await n(f.data||{},{newData:r,oldData:o,context:i},s),a=await n(f.filter||{},{newData:r,oldData:o,context:i},s),u=await e(f.limit,{newData:r,oldData:o,context:i},s),y=f.collection;l?.info(`[Automations] action update_many in ${y} filter=${JSON.stringify(a)} data=${JSON.stringify(t)} limit=${JSON.stringify(u)}`);try{const e=await c.update_many({collection:y,filter:a,data:t,limit:u,context:i});f.assign&&e&&(i[`$${f.assign}`]=e,l?.info(`[Automations] assigned $${f.assign} = ${JSON.stringify(e)}`))}catch(t){l?.error("[Automations] update_many failed",t?.message||t)}}}}async function e(t,{newData:e,oldData:n,context:a},o){if("NOW()"===t)return(new Date).toISOString();if("$USER.id"===t)return a?.$USER?.id??null;if(r(t))try{return await o.evaluateValue(t,a)}catch{return}return"string"==typeof t||"number"==typeof t||"boolean"==typeof t||null==t?t:null}async function n(t,{newData:a,oldData:o,context:i},u){if(Array.isArray(t)){const e=[];for(const r of t)e.push(await n(r,{newData:a,oldData:o,context:i},u));return e}if(t&&"object"==typeof t){if(r(t)){const n=await e(t,{newData:a,oldData:o,context:i},u);if((t=>void 0!==t&&(null===t||["string","number","boolean"].includes(typeof t)||Array.isArray(t)))(n))return n}const s={};for(const[e,r]of Object.entries(t))s[e]=await n(r,{newData:a,oldData:o,context:i},u);return s}return await e(t,{newData:a,oldData:o,context:i},u)}const a=new Set(["var","if","and","or","!","!!","===","==","!=",">",">=","<","<=","+","-","*","/","%","in","cat","now","date_diff","date_add","concat","matches","imatches","iif","case","get","coalesce","length","map_by","filter_by","reduce_by","sum_by","any_by","all_by","lookup","lookup_many","changed_to","__ctx"]);function r(t){if(!t||"object"!=typeof t||Array.isArray(t))return!1;const e=Object.keys(t);return 1===e.length&&a.has(e[0])}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function o(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var i={exports:{}};i.exports=function(){function t(t){for(var e=[],n=0,a=t.length;n<a;n++)-1===e.indexOf(t[n])&&e.push(t[n]);return e}Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)});var e={},n={"==":function(t,e){return t==e},"===":function(t,e){return t===e},"!=":function(t,e){return t!=e},"!==":function(t,e){return t!==e},">":function(t,e){return t>e},">=":function(t,e){return t>=e},"<":function(t,e,n){return void 0===n?t<e:t<e&&e<n},"<=":function(t,e,n){return void 0===n?t<=e:t<=e&&e<=n},"!!":function(t){return e.truthy(t)},"!":function(t){return!e.truthy(t)},"%":function(t,e){return t%e},log:function(t){return console.log(t),t},in:function(t,e){return!(!e||void 0===e.indexOf)&&-1!==e.indexOf(t)},cat:function(){return Array.prototype.join.call(arguments,"")},substr:function(t,e,n){if(n<0){var a=String(t).substr(e);return a.substr(0,a.length+n)}return String(t).substr(e,n)},"+":function(){return Array.prototype.reduce.call(arguments,function(t,e){return parseFloat(t,10)+parseFloat(e,10)},0)},"*":function(){return Array.prototype.reduce.call(arguments,function(t,e){return parseFloat(t,10)*parseFloat(e,10)})},"-":function(t,e){return void 0===e?-t:t-e},"/":function(t,e){return t/e},min:function(){return Math.min.apply(this,arguments)},max:function(){return Math.max.apply(this,arguments)},merge:function(){return Array.prototype.reduce.call(arguments,function(t,e){return t.concat(e)},[])},var:function(t,e){var n=void 0===e?null:e,a=this;if(void 0===t||""===t||null===t)return a;for(var r=String(t).split("."),o=0;o<r.length;o++){if(null==a)return n;if(void 0===(a=a[r[o]]))return n}return a},missing:function(){for(var t=[],n=Array.isArray(arguments[0])?arguments[0]:arguments,a=0;a<n.length;a++){var r=n[a],o=e.apply({var:r},this);null!==o&&""!==o||t.push(r)}return t},missing_some:function(t,n){var a=e.apply({missing:n},this);return n.length-a.length>=t?[]:a}};return e.is_logic=function(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)&&1===Object.keys(t).length},e.truthy=function(t){return!(Array.isArray(t)&&0===t.length||!t)},e.get_operator=function(t){return Object.keys(t)[0]},e.get_values=function(t){return t[e.get_operator(t)]},e.apply=function(t,a){if(Array.isArray(t))return t.map(function(t){return e.apply(t,a)});if(!e.is_logic(t))return t;var r,o,i,u,s,l=e.get_operator(t),c=t[l];if(Array.isArray(c)||(c=[c]),"if"===l||"?:"==l){for(r=0;r<c.length-1;r+=2)if(e.truthy(e.apply(c[r],a)))return e.apply(c[r+1],a);return c.length===r+1?e.apply(c[r],a):null}if("and"===l){for(r=0;r<c.length;r+=1)if(o=e.apply(c[r],a),!e.truthy(o))return o;return o}if("or"===l){for(r=0;r<c.length;r+=1)if(o=e.apply(c[r],a),e.truthy(o))return o;return o}if("filter"===l)return u=e.apply(c[0],a),i=c[1],Array.isArray(u)?u.filter(function(t){return e.truthy(e.apply(i,t))}):[];if("map"===l)return u=e.apply(c[0],a),i=c[1],Array.isArray(u)?u.map(function(t){return e.apply(i,t)}):[];if("reduce"===l)return u=e.apply(c[0],a),i=c[1],s=void 0!==c[2]?e.apply(c[2],a):null,Array.isArray(u)?u.reduce(function(t,n){return e.apply(i,{current:n,accumulator:t})},s):s;if("all"===l){if(u=e.apply(c[0],a),i=c[1],!Array.isArray(u)||!u.length)return!1;for(r=0;r<u.length;r+=1)if(!e.truthy(e.apply(i,u[r])))return!1;return!0}if("none"===l){if(u=e.apply(c[0],a),i=c[1],!Array.isArray(u)||!u.length)return!0;for(r=0;r<u.length;r+=1)if(e.truthy(e.apply(i,u[r])))return!1;return!0}if("some"===l){if(u=e.apply(c[0],a),i=c[1],!Array.isArray(u)||!u.length)return!1;for(r=0;r<u.length;r+=1)if(e.truthy(e.apply(i,u[r])))return!0;return!1}if(c=c.map(function(t){return e.apply(t,a)}),n.hasOwnProperty(l)&&"function"==typeof n[l])return n[l].apply(a,c);if(l.indexOf(".")>0){var f=String(l).split("."),y=n;for(r=0;r<f.length;r++){if(!y.hasOwnProperty(f[r]))throw new Error("Unrecognized operation "+l+" (failed at "+f.slice(0,r+1).join(".")+")");y=y[f[r]]}return y.apply(a,c)}throw new Error("Unrecognized operation "+l)},e.uses_data=function(n){var a=[];if(e.is_logic(n)){var r=e.get_operator(n),o=n[r];Array.isArray(o)||(o=[o]),"var"===r?a.push(o[0]):o.forEach(function(t){a.push.apply(a,e.uses_data(t))})}return t(a)},e.add_operation=function(t,e){n[t]=e},e.rm_operation=function(t){delete n[t]},e.rule_like=function(t,n){if(n===t)return!0;if("@"===n)return!0;if("number"===n)return"number"==typeof t;if("string"===n)return"string"==typeof t;if("array"===n)return Array.isArray(t)&&!e.is_logic(t);if(e.is_logic(n)){if(e.is_logic(t)){var a=e.get_operator(n),r=e.get_operator(t);if("@"===a||a===r)return e.rule_like(e.get_values(t,!1),e.get_values(n,!1))}return!1}if(Array.isArray(n)){if(Array.isArray(t)){if(n.length!==t.length)return!1;for(var o=0;o<n.length;o+=1)if(!e.rule_like(t[o],n[o]))return!1;return!0}return!1}return!1},e}();var u=o(i.exports);function s(t){if(null==t)return null;if("object"==typeof t)return t;if("string"==typeof t)try{return JSON.parse(t)}catch{return t}return t}function l(t){let e=t.rule??t.rule_jsonb??t.trigger??null;e=s(e);let n=t.actions??t.actions_jsonb??[];n=s(n),n&&!Array.isArray(n)&&(n=n.type?[n]:[]);let a=t.collection_cible;return a=s(a),{...t,rule:e,actions:n,collection_cible:a}}var c=({action:e,filter:n},{services:a,database:r,logger:o,getSchema:i})=>{const{ItemsService:s}=a,c=function(t={}){function e(t){return Array.isArray(t)?t:[]}function n(t,e){try{if(t&&"object"==typeof t&&!Array.isArray(t))return u.apply(t,e);if("string"==typeof t){const n=t.split(".");let a=e.it;for(const t of n)a=a?.[t];return a}return t}catch{return}}u.add_operation("now",()=>(new Date).toISOString()),u.add_operation("date_diff",(t,e,n="days")=>{const a=new Date(t)-new Date(e);if(!Number.isFinite(a))return 0;const r="hours"===n?36e5:"minutes"===n?6e4:864e5;return Math.floor(a/r)}),u.add_operation("date_add",(t,e,n="days")=>{const a=new Date(t);return Number.isFinite(e)&&("minutes"===n?a.setMinutes(a.getMinutes()+e):"hours"===n?a.setHours(a.getHours()+e):a.setDate(a.getDate()+e)),a.toISOString()}),u.add_operation("concat",(...t)=>t.filter(t=>null!=t).join("")),u.add_operation("matches",(t,e,n="")=>{try{const a=String(n??"").replace(/[^gimsuy]/g,"");return new RegExp(e??"",a).test(String(t??""))}catch{return!1}}),u.add_operation("imatches",(t,e)=>{try{return new RegExp(e??"","i").test(String(t??""))}catch{return!1}}),u.add_operation("iif",(t,e,n)=>t?e:n),u.add_operation("case",(...t)=>{for(let e=0;e<t.length-1;e+=2)if(t[e])return t[e+1];return t.length%2==1?t[t.length-1]:null}),u.add_operation("get",(t,e,n=null)=>{if(null==t||null==e)return n;const a=Array.isArray(e)?e:String(e).split(".");let r=t;for(const t of a){if(null==r)return n;r=r[t]}return null==r?n:r}),u.add_operation("coalesce",(...t)=>{for(const e of t)if(null!=e)return e;return null}),u.add_operation("length",t=>null==t?0:Array.isArray(t)?t.length:"object"==typeof t?Object.keys(t).length:String(t).length),u.add_operation("map_by",(t,a,r)=>{try{return e(t).map(t=>n(a,{...r||{},it:t}))}catch{return[]}}),u.add_operation("filter_by",(t,a,r)=>{try{return e(t).filter(t=>!!n(a,{...r||{},it:t}))}catch{return[]}}),u.add_operation("reduce_by",(t,a,r,o)=>{try{return e(t).reduce((t,e)=>n(r,{...o||{},acc:t,it:e}),a)}catch{return a}}),u.add_operation("sum_by",(t,a,r)=>{try{return e(t).reduce((t,e)=>t+Number(n(a,{...r||{},it:e})||0),0)}catch{return 0}}),u.add_operation("any_by",(t,a,r)=>{try{return e(t).some(t=>!!n(a,{...r||{},it:t}))}catch{return!1}}),u.add_operation("all_by",(t,a,r)=>{try{return e(t).every(t=>!!n(a,{...r||{},it:t}))}catch{return!1}});const a=t.getItem,r=t.listItems;function o(t,e){if(t&&"object"==typeof t){if(1===Object.keys(t).length&&Object.prototype.hasOwnProperty.call(t,"var"))try{return u.apply(t,e)}catch{return null}if(Array.isArray(t))return t.map(t=>o(t,e));const n={};for(const[a,r]of Object.entries(t))n[a]=o(r,e);return n}return t}return u.add_operation("lookup",async(t,e,n=["*"],r)=>{try{return a?await a(t,e,o(n,r)):null}catch{return null}}),u.add_operation("lookup_many",async(t,e={},n=["*"],a=50,i)=>{try{if(!r)return[];const u=o(e,i)||{},s=o(n,i)||["*"],l=Number.isFinite(a)?a:50;return await r(t,u,s,l)}catch{return[]}}),u.add_operation("changed_to",(t,e,n,a)=>{try{return!(!Array.isArray(n)||!n.includes(t))&&u.apply({"===":[{var:t},e]},a)}catch{return!1}}),{evaluateRule:async function(t,e){try{return u.add_operation("__ctx",()=>e),!!await u.apply(t,e)}catch{return!1}},evaluateValue:async function(t,e){try{return u.add_operation("__ctx",()=>e),await u.apply(t,e)}catch{return null}}}}({getItem:async(t,e,n=["*"])=>{const a=await i();return new s(t,{database:r,schema:a}).readOne(e,{fields:n})},listItems:async(t,e={},n=["*"],a=50)=>{const o=await i(),u=new s(t,{database:r,schema:o}),l=await u.readByQuery({filter:e,fields:n,limit:a});return Array.isArray(l)?l:l?.data||[]}});let d=[],p=null;const m=new Map;function g({rule:t,collection:e,meta:n,scope:a}){const r=["auto",String(t.id??t.name??"unknown")];return"collection"===a?r.push(String(e)):"item"===a?r.push(String(n?.keys?.[0]??"unknown")):"user"===a&&r.push(String(n?.accountability?.user??"anon")),r.join("::")}async function h(){try{const t=new s("quartz_automations",{database:r,schema:await i()}),e=await t.readByQuery({limit:-1,sort:["priority"],fields:["id","name","status","collection_cible","rule","rule_jsonb","actions","actions_jsonb","priority","expand_fields","trigger_event","throttle_ms","throttle_scope"],filter:{status:{_eq:"active"}}}),n=Array.isArray(e)?e:e?.data||[];d=function(t){return(t||[]).map(l)}(n),o.info(`[Automations] ðŸ“‹ Loaded ${d.length} active rules (normalized)`);for(const t of d){const e=Array.isArray(t.actions)?t.actions.length:0,n=Array.isArray(t.collection_cible)?t.collection_cible.join(","):t.collection_cible||"any";o.info(`[Automations]   - "${t.name||t.id}" on ${n} with ${e} actions`),0===e&&o.warn(`[Automations] âš ï¸ Rule '${t.name||t.id}' has no actions after normalization`)}return!0}catch(t){return o.warn(`[Automations] Can't load rules (table missing yet?) â†’ ${t?.message||t}`),d=[],!1}}function _(){const t=d.map(t=>`${t.id}:${t.name}:${JSON.stringify(t.rule)}:${JSON.stringify(t.actions)}`).join("|");let e=0;for(let n=0;n<t.length;n++){e=(e<<5)-e+t.charCodeAt(n),e&=e}return e.toString(16)}const A=function({evaluator:e,logger:n,executors:a={}}){return{async evaluate({collection:r,automations:o,newData:i,oldData:u,context:s}){const l={},c=Object.keys(i||{}).filter(t=>!u||i[t]!==u[t]);for(const f of o)try{if(f.collection_cible){const t=f.collection_cible;if(!(Array.isArray(t)?t.includes(r):t===r))continue}if(f.status&&"active"!==f.status)continue;const o=f.rule||f.rule_jsonb||f.trigger;if(!o)continue;const y={...{...u||{},...i||{}},$OLD:u||{},$CHANGED:c,$USER:s?.$USER||null,$AUTOMATION:{id:f.id,name:f.name,throttle_ms:f.throttle_ms,throttle_scope:f.throttle_scope}},d=await e.evaluateRule(o,y);if(n?.info(`[Automations] rule ${f.name||f.id||""} match=${d} changed=[${c.join(", ")}]`),!d)continue;const p=Array.isArray(f.actions)?f.actions:[];await t(p,{newData:i,oldData:u,context:y,updates:l,evaluator:e,logger:n,executors:a})}catch(t){n?.error("[Automations] Rule failed:",f?.name||f?.id,t?.message||t)}return l}}}({evaluator:c,logger:o,executors:{async create_item({collection:t,data:e,context:n}){if(!t)throw new Error("create_item requires collection");const a=await i(),o=new s(t,{database:r,schema:a}),u={user:n?.$USER?.id,_automationTriggered:!0};return await o.createOne(e,{accountability:u})},async update_item({collection:t,id:e,data:n,context:a}){if(!t)throw new Error("update_item requires collection");if(!e)throw new Error("update_item requires id");const o=await i(),u=new s(t,{database:r,schema:o}),l={user:a?.$USER?.id,_automationTriggered:!0};return await u.updateOne(e,n,{accountability:l})},async update_many({collection:t,filter:e={},data:n={},limit:a=-1,context:u}){if(!t)throw new Error("update_many requires collection");const l=await i(),c=new s(t,{database:r,schema:l}),f={user:u?.$USER?.id,_automationTriggered:!0};try{if("function"==typeof c.updateByQuery){const t={filter:e,limit:a},r=await c.updateByQuery(t,n,{accountability:f});return{count:Array.isArray(r)?r.length:r?.length??null}}}catch(e){o.warn(`[Automations] updateByQuery failed on ${t}: ${e?.message||e}`)}const y=(l.collections?.[t]||{}).primary||"id",d=await c.readByQuery({filter:e,limit:a,fields:[y]}),p=(Array.isArray(d)?d:d?.data||[]).map(t=>t?.[y]).filter(t=>null!=t);return 0===p.length?{count:0}:(await c.updateMany(p,n,{accountability:f}),{count:p.length})},async trigger_flow({key:t,payload:n,context:a}){await e("automations.trigger.flow",{key:t,payload:n,user:a?.$USER?.id})},async send_email({to:t,subject:e,body:n,context:a}){o.info(`[Automations] (stub) send_email to=${t} subject=${e}`)}}});function w(t=""){p&&clearTimeout(p),p=setTimeout(async()=>{o.info(`[Automations] ðŸ”„ Auto-reloading automations (reason: ${t})...`);const e=await async function({attempts:t=3,settleDelayMs:e=700,reason:n="unknown"}={}){let a=null;for(let r=1;r<=t;r++){await h();const i=_();if(o.debug(`[Automations] Reload attempt ${r}/${t} (reason: ${n}) signature: ${i}`),a&&i===a)return o.info(`[Automations] ðŸ”’ Reload stabilized on attempt ${r} (reason: ${n})`),!0;a=i,r<t&&await new Promise(t=>setTimeout(t,e))}return o.info(`[Automations] âœ… Reload completed after ${t} attempts (reason: ${n})`),!0}({attempts:3,settleDelayMs:700,reason:t});if(e){const t=d.map(t=>{const e=Array.isArray(t.trigger_event)?t.trigger_event.join(","):t.trigger_event||"update";return`${t.name}[${e}]`}).join(", ");o.info(`[Automations] ðŸŽ¯ Active automations: ${t}`)}else o.warn("[Automations] âš ï¸ Reload had issues");p=null},300)}h(),e("automations.reload",async()=>(await h(),{success:!0,count:d.length})),e("items.create",async(t,e)=>{"quartz_automations"===e?.collection&&(o.info("[Automations] ðŸ†• Detected create on quartz_automations"),w("create"))}),e("items.update",async(t,e)=>{"quartz_automations"===e?.collection&&(o.info("[Automations] âœï¸ Detected update on quartz_automations"),w("update"))}),e("items.delete",async(t,e)=>{"quartz_automations"===e?.collection&&(o.info("[Automations] ðŸ—‘ï¸ Detected delete on quartz_automations"),w("delete"))}),n("items.update",async(t,e)=>{try{if("quartz_automations"===e?.collection)return o.info("[Automations] âœï¸ Detected update on quartz_automations (via filter), scheduling reload"),w("items.update on quartz_automations"),t;const n=y(d,"update").filter(t=>f(t,e.collection));if(0===n.length)return t;const a=await i(),u=new s(e.collection,{database:r,schema:a}),l=function(t,e){const n=new Set;for(const a of t){if(!f(a,e))continue;const t=Array.isArray(a.expand_fields)?a.expand_fields:[];for(const e of t)"string"==typeof e&&n.add(e)}return Array.from(n)}(n,e.collection),c=await u.readOne(e.keys?.[0],l.length?{fields:l}:void 0),p=Object.keys(t||{}).filter(e=>!c||t[e]!==c[e]);o.info(`[Automations] items.update on ${e.collection} id=${e.keys?.[0]} changed=[${p.join(", ")}] rules=${n.length}`);const h={},_=[];for(const a of n){const n=Number(a.throttle_ms)||0,r=a.throttle_scope||"rule";if(n>0){const i=g({rule:a,collection:e.collection,meta:e,scope:r});m.has(i)&&clearTimeout(m.get(i).timer);const u=m.get(i)||{lastPayload:null,lastOriginal:null};u.lastPayload=t,u.lastOriginal=c;const s=setTimeout(async()=>{try{const t=await A.evaluate({collection:e.collection,automations:[a],newData:u.lastPayload,oldData:u.lastOriginal,context:{$USER:e?.accountability?.user}});Object.assign(h,t)}catch(t){o.error("[Automations] throttled evaluate failed",t?.message||t)}m.delete(i)},n);m.set(i,{timer:s,...u})}else _.push(A.evaluate({collection:e.collection,automations:[a],newData:t,oldData:c,context:{$USER:e?.accountability?.user}}).then(t=>Object.assign(h,t)).catch(t=>o.error("[Automations] evaluate failed",t?.message||t)))}return await Promise.all(_),Object.keys(h).length>0?o.info(`[Automations] updates computed â†’ ${JSON.stringify(h)}`):o.info("[Automations] no updates computed"),{...t,...h}}catch(e){return o.error("[Automations] Error in items.update:",e?.message||e),t}}),n("items.create",async(t,e)=>{try{if("quartz_automations"===e?.collection)return o.info("[Automations] ðŸ†• Detected create on quartz_automations (via filter), scheduling reload"),w("items.create on quartz_automations"),t;const n=y(d,"create").filter(t=>f(t,e.collection));if(0===n.length)return t;if(e?.accountability?._automationTriggered)return o.info(`[Automations] items.create on ${e.collection} SKIPPED (automation-triggered)`),t;o.info(`[Automations] items.create on ${e.collection} rules=${n.length}`);const a={},r=[];for(const i of n){const n=Number(i.throttle_ms)||0,u=i.throttle_scope||"rule";if(n>0){const r=g({rule:i,collection:e.collection,meta:e,scope:u});m.has(r)&&clearTimeout(m.get(r).timer);const s=m.get(r)||{lastPayload:null,lastOriginal:null};s.lastPayload=t,s.lastOriginal=null;const l=setTimeout(async()=>{try{const t=await A.evaluate({collection:e.collection,automations:[i],newData:s.lastPayload,oldData:s.lastOriginal,context:{$USER:e?.accountability?.user}});Object.assign(a,t)}catch(t){o.error("[Automations] throttled evaluate failed",t?.message||t)}m.delete(r)},n);m.set(r,{timer:l,...s})}else r.push(A.evaluate({collection:e.collection,automations:[i],newData:t,oldData:null,context:{$USER:e?.accountability?.user}}).then(t=>Object.assign(a,t)).catch(t=>o.error("[Automations] evaluate failed",t?.message||t)))}return await Promise.all(r),Object.keys(a).length>0?o.info(`[Automations] updates computed â†’ ${JSON.stringify(a)}`):o.info("[Automations] no updates computed"),{...t,...a}}catch(e){return o.error("[Automations] Error in items.create:",e?.message||e),t}})};function f(t,e){const n=t.collection_cible;return!n||(Array.isArray(n)?n.includes(e):n===e)}function y(t,e){return t.filter(t=>{let n,a=t.trigger_event;if(a||(a=["update"]),Array.isArray(a))n=a;else if("string"==typeof a){if("*"===a)return!0;n=a.split(",").map(t=>t.trim())}else n=["update"];return n.includes("*")||n.includes(e)})}export{c as default};
