import{useApi as e,useStores as r,defineModule as a}from"@directus/extensions-sdk";import{ref as n,computed as l,watch as t,onMounted as s,resolveComponent as o,resolveDirective as d,createBlock as c,openBlock as i,withCtx as u,createElementVNode as v,createElementBlock as m,createVNode as b,createTextVNode as g,toDisplayString as p,createCommentVNode as f,normalizeClass as h,withDirectives as y,vModelText as x,Fragment as k,renderList as w,withModifiers as C,vModelCheckbox as _}from"vue";var z=[],S=[];!function(e,r){if(e&&"undefined"!=typeof document){var a,n=!0===r.prepend?"prepend":"append",l=!0===r.singleTag,t="string"==typeof r.container?document.querySelector(r.container):document.getElementsByTagName("head")[0];if(l){var s=z.indexOf(t);-1===s&&(s=z.push(t)-1,S[s]={}),a=S[s]&&S[s][n]?S[s][n]:S[s][n]=o()}else a=o();65279===e.charCodeAt(0)&&(e=e.substring(1)),a.styleSheet?a.styleSheet.cssText+=e:a.appendChild(document.createTextNode(e))}function o(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),r.attributes)for(var a=Object.keys(r.attributes),l=0;l<a.length;l++)e.setAttribute(a[l],r.attributes[a[l]]);var s="prepend"===n?"afterbegin":"beforeend";return t.insertAdjacentElement(s,e),e}}('\r\n/* Container - Ultra compact for single page view */\n.recalc-container[data-v-21d73cb7] {\r\n  padding: 0.75rem;\r\n  padding-top: 0;\r\n  max-width: 1400px;\r\n  margin: 0 auto;\r\n  height: calc(100vh - 110px);\r\n  overflow-y: auto;\n}\n.recalc-loading[data-v-21d73cb7] {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 0.75rem;\r\n  justify-content: center;\r\n  padding: 1.5rem;\r\n  color: var(--theme--foreground-subdued);\n}\r\n\r\n/* Result Card - Modern Design */\n.result-card[data-v-21d73cb7] {\r\n  background: var(--theme--background);\r\n  border: 1px solid var(--theme--border-color);\r\n  border-radius: var(--theme--border-radius);\r\n  margin-bottom: 0.75rem;\r\n  overflow: hidden;\r\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);\n}\n.result-card-header[data-v-21d73cb7] {\r\n  display: flex;\r\n  align-items: flex-start;\r\n  gap: 1rem;\r\n  padding: 1rem;\r\n  border-bottom: 1px solid var(--theme--border-color-subdued);\n}\n.result-card-header.result-success[data-v-21d73cb7] {\r\n  background: linear-gradient(to right, #e8f5e9 0%, var(--theme--background) 100%);\r\n  border-left: 4px solid #4caf50;\n}\n.result-card-header.result-warning[data-v-21d73cb7] {\r\n  background: linear-gradient(to right, #fff3e0 0%, var(--theme--background) 100%);\r\n  border-left: 4px solid #ff9800;\n}\n.result-icon[data-v-21d73cb7] {\r\n  flex-shrink: 0;\r\n  color: inherit;\n}\n.result-success .result-icon[data-v-21d73cb7] {\r\n  color: #4caf50;\n}\n.result-warning .result-icon[data-v-21d73cb7] {\r\n  color: #ff9800;\n}\n.result-main[data-v-21d73cb7] {\r\n  flex: 1;\r\n  min-width: 0;\n}\n.result-title[data-v-21d73cb7] {\r\n  margin: 0 0 0.5rem 0;\r\n  color: var(--theme--foreground);\r\n  font-size: 1rem;\r\n  font-weight: 600;\r\n  line-height: 1.3;\n}\n.result-meta[data-v-21d73cb7] {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 0.75rem;\r\n  flex-wrap: wrap;\r\n  font-size: 0.75rem;\r\n  color: var(--theme--foreground-subdued);\n}\n.result-collection[data-v-21d73cb7] {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  gap: 0.25rem;\r\n  font-weight: 500;\r\n  color: var(--theme--primary);\n}\n.result-fields-count[data-v-21d73cb7] {\r\n  color: var(--theme--foreground-subdued);\n}\n.result-badge[data-v-21d73cb7] {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  gap: 0.25rem;\r\n  padding: 0.15rem 0.5rem;\r\n  border-radius: 999px;\r\n  font-weight: 500;\r\n  font-size: 0.7rem;\n}\n.result-badge-dry[data-v-21d73cb7] {\r\n  background: var(--theme--background-subdued);\r\n  color: var(--theme--foreground);\r\n  border: 1px solid var(--theme--border-color);\n}\n.result-stats[data-v-21d73cb7] {\r\n  display: grid;\r\n  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));\r\n  gap: 0;\n}\n.result-stat[data-v-21d73cb7] {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 0.75rem;\r\n  padding: 1rem;\r\n  border-right: 1px solid var(--theme--border-color-subdued);\r\n  transition: background 0.15s;\n}\n.result-stat[data-v-21d73cb7]:last-child {\r\n  border-right: none;\n}\n.result-stat[data-v-21d73cb7]:hover {\r\n  background: var(--theme--background-subdued);\n}\n.result-stat-icon[data-v-21d73cb7] {\r\n  flex-shrink: 0;\r\n  color: var(--theme--primary);\r\n  opacity: 0.7;\n}\n.result-stat-content[data-v-21d73cb7] {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 0.15rem;\r\n  min-width: 0;\n}\n.result-stat-label[data-v-21d73cb7] {\r\n  font-size: 0.65rem;\r\n  color: var(--theme--foreground-subdued);\r\n  text-transform: uppercase;\r\n  letter-spacing: 0.5px;\r\n  font-weight: 500;\n}\n.result-stat-value[data-v-21d73cb7] {\r\n  font-size: 1.25rem;\r\n  font-weight: 700;\r\n  color: var(--theme--foreground);\r\n  line-height: 1;\n}\r\n\r\n/* Progress Card - Ultra Compact */\n.progress-card[data-v-21d73cb7] {\r\n  background: var(--theme--background);\r\n  border: 1px solid var(--theme--border-color);\r\n  border-radius: var(--theme--border-radius);\r\n  padding: 0.75rem;\r\n  margin-bottom: 0.75rem;\n}\n.progress-card h3[data-v-21d73cb7] {\r\n  margin: 0 0 0.5rem 0;\r\n  color: var(--theme--foreground);\r\n  font-size: 0.95rem;\r\n  font-weight: 600;\n}\n.progress-details[data-v-21d73cb7] {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  margin-top: 0.5rem;\r\n  font-size: 0.75rem;\r\n  color: var(--theme--foreground-subdued);\n}\r\n\r\n/* Content Grid - Ultra Compact */\n.content-grid[data-v-21d73cb7] {\r\n  display: grid;\r\n  grid-template-columns: 1fr 320px;\r\n  gap: 0.75rem;\r\n  align-items: start;\n}\n@media (max-width: 1024px) {\n.content-grid[data-v-21d73cb7] {\r\n    grid-template-columns: 1fr;\n}\n}\r\n\r\n/* Config Card - Ultra Compact */\n.config-card[data-v-21d73cb7] {\r\n  background: var(--theme--background);\r\n  border: 1px solid var(--theme--border-color);\r\n  border-radius: var(--theme--border-radius);\r\n  padding: 0.75rem;\n}\n.card-header[data-v-21d73cb7] {\r\n  margin-bottom: 0.75rem;\n}\n.card-title[data-v-21d73cb7] {\r\n  margin: 0;\r\n  color: var(--theme--foreground);\r\n  font-size: 0.95rem;\r\n  font-weight: 600;\n}\n.card-body[data-v-21d73cb7] {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 0.75rem;\n}\r\n\r\n/* Form Groups - Ultra Compact */\n.form-group[data-v-21d73cb7] {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 0.3rem;\n}\n.form-label[data-v-21d73cb7] {\r\n  font-weight: 500;\r\n  color: var(--theme--foreground);\r\n  font-size: 0.75rem;\n}\n.form-subtitle[data-v-21d73cb7] {\r\n  font-size: 0.65rem;\r\n  color: var(--theme--foreground-subdued);\n}\n.form-hint-warning[data-v-21d73cb7] {\r\n  color: var(--theme--warning, var(--theme--danger));\r\n  font-weight: 500;\n}\n.form-hint[data-v-21d73cb7] {\r\n  font-size: 0.65rem;\r\n  color: var(--theme--foreground-subdued);\r\n  margin-top: -0.15rem;\n}\n.form-error[data-v-21d73cb7] {\r\n  color: var(--theme--danger);\r\n  font-size: 0.7rem;\r\n  margin-top: 0.2rem;\n}\r\n\r\n/* Fields Container - Ultra Compact */\n.fields-container[data-v-21d73cb7] {\r\n  border: 1px solid var(--theme--border-color);\r\n  border-radius: var(--theme--border-radius);\r\n  max-height: 220px;\r\n  overflow-y: auto;\r\n  background: var(--theme--background);\n}\n.fields-header[data-v-21d73cb7] {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 0.5rem;\r\n  padding: 0.65rem 0.75rem 0.75rem;\r\n  background: var(--theme--background-subdued);\r\n  border-bottom: 1px solid var(--theme--border-color);\r\n  position: sticky;\r\n  top: 0;\r\n  z-index: 1;\n}\n.fields-header[data-v-21d73cb7]:hover {\r\n  background: var(--theme--background-accent);\n}\n.fields-header-top[data-v-21d73cb7] {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: space-between;\r\n  gap: 0.5rem;\n}\n.fields-header-title[data-v-21d73cb7] {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 0.5rem;\r\n  font-weight: 600;\r\n  font-size: 0.75rem;\r\n  user-select: none;\n}\n.fields-header-title input[type="checkbox"][data-v-21d73cb7] {\r\n  cursor: pointer;\n}\n.fields-header-title label[data-v-21d73cb7] {\r\n  cursor: pointer;\r\n  margin: 0;\n}\n.fields-count[data-v-21d73cb7] {\r\n  font-size: 0.65rem;\r\n  color: var(--theme--foreground-subdued);\r\n  background: var(--theme--background);\r\n  border: 1px solid var(--theme--border-color-subdued);\r\n  border-radius: 999px;\r\n  padding: 0.15rem 0.5rem;\r\n  line-height: 1;\n}\n.fields-search[data-v-21d73cb7],\r\n.select-search[data-v-21d73cb7] {\r\n  width: 100%;\r\n  padding: 0.35rem 0.5rem;\r\n  border: 1px solid var(--theme--border-color-subdued);\r\n  border-radius: var(--theme--border-radius);\r\n  font-size: 0.75rem;\r\n  color: var(--theme--foreground);\r\n  background: var(--theme--background);\r\n  transition: border-color 0.15s, box-shadow 0.15s;\n}\n.fields-search[data-v-21d73cb7]:focus,\r\n.select-search[data-v-21d73cb7]:focus {\r\n  border-color: var(--theme--primary);\r\n  outline: none;\r\n  box-shadow: 0 0 0 1px var(--theme--primary-20, rgba(80, 86, 231, 0.2));\n}\n.fields-search[data-v-21d73cb7]::placeholder,\r\n.select-search[data-v-21d73cb7]::placeholder {\r\n  color: var(--theme--foreground-subdued);\n}\n.select-group-header[data-v-21d73cb7] {\r\n  display: flex;\r\n  align-items: flex-start;\r\n  justify-content: space-between;\r\n  gap: 0.5rem;\n}\n.select-group-titles[data-v-21d73cb7] {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 0.15rem;\n}\n.select-count[data-v-21d73cb7] {\r\n  font-size: 0.65rem;\r\n  color: var(--theme--foreground-subdued);\r\n  background: var(--theme--background-subdued);\r\n  border-radius: 999px;\r\n  padding: 0.15rem 0.5rem;\r\n  line-height: 1;\r\n  font-weight: 600;\n}\n.field-item[data-v-21d73cb7] {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 0.5rem;\r\n  padding: 0.5rem 0.75rem;\r\n  border-bottom: 1px solid var(--theme--border-color-subdued);\r\n  cursor: pointer;\r\n  user-select: none;\r\n  transition: background 0.15s;\n}\n.field-item[data-v-21d73cb7]:last-child {\r\n  border-bottom: none;\n}\n.field-item[data-v-21d73cb7]:hover {\r\n  background: var(--theme--background-accent);\n}\n.field-item input[type="checkbox"][data-v-21d73cb7] {\r\n  cursor: pointer;\n}\n.field-item label[data-v-21d73cb7] {\r\n  cursor: pointer;\r\n  margin: 0;\r\n  font-size: 0.75rem;\r\n  color: var(--theme--foreground);\r\n  flex: 1;\n}\n.fields-empty[data-v-21d73cb7] {\r\n  padding: 1.25rem;\r\n  text-align: center;\r\n  color: var(--theme--foreground-subdued);\r\n  font-size: 0.75rem;\n}\r\n\r\n/* Scrollbar */\n.fields-container[data-v-21d73cb7]::-webkit-scrollbar {\r\n  width: 6px;\n}\n.fields-container[data-v-21d73cb7]::-webkit-scrollbar-track {\r\n  background: var(--theme--background-subdued);\n}\n.fields-container[data-v-21d73cb7]::-webkit-scrollbar-thumb {\r\n  background: var(--theme--border-color);\r\n  border-radius: 3px;\n}\n.fields-container[data-v-21d73cb7]::-webkit-scrollbar-thumb:hover {\r\n  background: var(--theme--foreground-subdued);\n}\r\n\r\n/* Action Buttons - Ultra Compact */\n.action-buttons[data-v-21d73cb7] {\r\n  display: flex;\r\n  gap: 0.5rem;\r\n  margin-top: 0.75rem;\n}\r\n\r\n/* Sidebar - Ultra Compact */\n.sidebar[data-v-21d73cb7] {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 0.75rem;\n}\r\n\r\n/* Stats Card - Ultra Compact */\n.stats-card[data-v-21d73cb7] {\r\n  background: var(--theme--background);\r\n  border: 1px solid var(--theme--border-color);\r\n  border-radius: var(--theme--border-radius);\r\n  padding: 0.75rem;\n}\n.stats-grid[data-v-21d73cb7] {\r\n  display: grid;\r\n  grid-template-columns: 1fr 1fr;\r\n  gap: 0.5rem;\n}\n.stat-box[data-v-21d73cb7] {\r\n  text-align: center;\r\n  padding: 0.6rem;\r\n  background: var(--theme--background-subdued);\r\n  border-radius: var(--theme--border-radius);\n}\n.stat-box .label[data-v-21d73cb7] {\r\n  display: block;\r\n  font-size: 0.6rem;\r\n  color: var(--theme--foreground-subdued);\r\n  text-transform: uppercase;\r\n  letter-spacing: 0.5px;\r\n  margin-bottom: 0.3rem;\n}\n.stat-box .value[data-v-21d73cb7] {\r\n  display: block;\r\n  font-size: 1.35rem;\r\n  font-weight: 700;\r\n  color: var(--theme--primary);\n}\r\n\r\n/* Recent Card - Ultra Compact */\n.recent-card[data-v-21d73cb7] {\r\n  background: var(--theme--background);\r\n  border: 1px solid var(--theme--border-color);\r\n  border-radius: var(--theme--border-radius);\r\n  padding: 0.75rem;\n}\n.formula-list[data-v-21d73cb7] {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 0.35rem;\r\n  margin-top: 0.5rem;\n}\n.formula-item[data-v-21d73cb7] {\r\n  padding: 0.5rem;\r\n  background: var(--theme--background-subdued);\r\n  border: 1px solid var(--theme--border-color-subdued);\r\n  border-radius: var(--theme--border-radius);\r\n  cursor: pointer;\r\n  transition: all 0.15s;\n}\n.formula-item[data-v-21d73cb7]:hover {\r\n  background: var(--theme--background-accent);\r\n  border-color: var(--theme--primary);\r\n  transform: translateX(2px);\n}\n.formula-item .collection[data-v-21d73cb7] {\r\n  font-weight: 600;\r\n  color: var(--theme--foreground);\r\n  font-size: 0.75rem;\r\n  margin-bottom: 0.15rem;\n}\n.formula-item .field[data-v-21d73cb7] {\r\n  color: var(--theme--foreground-subdued);\r\n  font-size: 0.65rem;\r\n  font-family: var(--theme--font-monospace);\n}\r\n',{});var R=(e,r)=>{const a=e.__vccOpts||e;for(const[e,n]of r)a[e]=n;return a};const U={class:"recalc-module"},V={key:0,class:"recalc-loading"},A={key:2,class:"recalc-container"},F={key:0,class:"result-card"},O={class:"result-icon"},N={class:"result-main"},j={class:"result-title"},M={class:"result-meta"},E={class:"result-collection"},L={key:0,class:"result-fields-count"},T={key:1,class:"result-badge result-badge-dry"},D={class:"result-stats"},q={class:"result-stat"},$={class:"result-stat-icon"},J={class:"result-stat-content"},B={class:"result-stat-value"},G={class:"result-stat"},I={class:"result-stat-icon"},P={class:"result-stat-content"},X={class:"result-stat-value"},H={key:0,class:"result-stat"},K={class:"result-stat-icon"},Q={class:"result-stat-content"},W={class:"result-stat-value"},Y={key:1,class:"progress-card"},Z={class:"progress-details"},ee={key:0},re={class:"content-grid"},ae={class:"config-card"},ne={class:"card-body"},le={class:"form-group"},te={class:"select-group-header"},se={key:0,class:"select-count"},oe=["disabled"],de={key:0,class:"form-hint form-hint-warning"},ce={class:"form-group"},ie={class:"fields-container"},ue={class:"fields-header"},ve={class:"fields-header-top"},me={class:"fields-header-title"},be=["checked",".indeterminate","disabled"],ge={key:0,class:"fields-count"},pe=["disabled"],fe={key:0,class:"fields-empty"},he={key:1,class:"fields-empty"},ye={key:2,class:"fields-empty"},xe=["onClick"],ke=["id","value"],we=["for"],Ce={class:"form-group"},_e={style:{display:"flex","align-items":"center","justify-content":"space-between","margin-bottom":"0.35rem"}},ze={style:{display:"flex","align-items":"center",gap:"0.35rem"}},Se={key:0,class:"form-error"},Re={class:"form-group"},Ue={class:"form-group"},Ve={class:"form-actions"},Ae={class:"sidebar"},Fe={class:"stats-card"},Oe={class:"card-body"},Ne={class:"stats-grid"},je={class:"stat-box"},Me={class:"stat-value"},Ee={class:"stat-box"},Le={class:"stat-value"},Te={key:0,class:"info-box"},De={class:"info-box-value"},qe={class:"info-box-detail"},$e={class:"recent-card"},Je={class:"formula-list"},Be=["onClick"],Ge={class:"formula-item-header"},Ie={class:"formula-name"},Pe={class:"formula-collection"},Xe={class:"formula-code"},He={class:"formula-meta"},Ke={key:0,class:"formula-empty"},Qe={key:2,class:"result-json"},We={__name:"module",setup(a){const z=e();let S=({title:e,message:r,type:a})=>{const n=r??"";"error"===a||"danger"===a?console.error(e,n):"warning"===a?console.warn(e,n):console.log(e,n)};try{const e="function"==typeof r?r():null,a=e?.useNotificationsStore?.();a?.add&&(S=({title:e,message:r,type:n})=>a.add({title:e,message:r,text:r,type:n}))}catch(e){}const R=n(!0),We=n(null),Ye=n([]),Ze=n(null),er=n([]),rr=n(""),ar=n(""),nr=n(""),lr=n(null),tr=n(!0),sr=n(100),or=n(!1),dr=n(!1),cr=n(null),ir=l(()=>{const e={};for(const r of Ye.value){const a=r.collection_cible;e[a]||(e[a]=[]),e[a].push(r)}return e}),ur=l(()=>Object.entries(ir.value).map(([e,r])=>({value:e,text:`${e} (${r.length} formule${r.length>1?"s":""})`}))),vr=l(()=>{if(!Ze.value)return[];return(ir.value[Ze.value]||[]).map(e=>e.champ_cible)}),mr=l(()=>{if(!rr.value.trim())return ur.value;const e=rr.value.trim().toLowerCase();return ur.value.filter(({value:r,text:a})=>{const n=`${r??""}`.toLowerCase(),l=`${a??""}`.toLowerCase();return n.includes(e)||l.includes(e)})}),br=l(()=>{const e=vr.value;if(!ar.value.trim())return e;const r=ar.value.trim().toLowerCase();return e.filter(e=>e.toLowerCase().includes(r))}),gr=l(()=>!!br.value.length&&br.value.every(e=>er.value.includes(e))),pr=l(()=>{if(!br.value.length)return!1;const e=br.value.filter(e=>er.value.includes(e));return e.length>0&&e.length<br.value.length}),fr=l(()=>[...Ye.value].sort((e,r)=>{const a=e.date_updated?new Date(e.date_updated):new Date(0);return(r.date_updated?new Date(r.date_updated):new Date(0))-a}).slice(0,5)),hr=l(()=>Boolean(Ze.value)&&!dr.value),yr=l(()=>cr.value?JSON.stringify(cr.value,null,2):"");function xr(e){const r=br.value.length?br.value:vr.value;if(r.length)if(e.target.checked){const e=new Set([...er.value,...r]);er.value=vr.value.filter(r=>e.has(r))}else{const e=new Set(r);er.value=er.value.filter(r=>!e.has(r))}}function kr(){Ze.value=null,er.value=[],rr.value="",ar.value="",nr.value="",lr.value=null,sr.value=100,or.value=!1,cr.value=null}async function wr(){R.value=!0,We.value=null;try{console.log("[Module] Chargement des formules depuis quartz_formulas...");const{data:e}=await z.get("/items/quartz_formulas",{params:{limit:-1,fields:["id","collection_cible","champ_cible","formula","scope","status","date_updated"]}});console.log("[Module] Formules reçues:",e),Ye.value=e?.data||[],console.log("[Module] Nombre de formules:",Ye.value.length),0===Object.keys(ir.value).length?Ze.value=null:Ze.value||(Ze.value=Object.keys(ir.value)[0])}catch(e){console.error("[Module] Erreur lors du chargement:",e);const r=e?.response?.data?.errors?.[0]?.message||e?.message||String(e);We.value=r,S({title:"Erreur de chargement",message:r,type:"error"})}finally{R.value=!1}}async function Cr(){if(!Ze.value)return void S({title:"Collection manquante",message:"Choisis une collection à recalculer.",type:"warning"});lr.value=null,cr.value=null;let e=null;try{e=function(){let e=null;if(nr.value&&nr.value.trim())try{e=JSON.parse(nr.value),lr.value=null}catch(e){throw lr.value=e?.message||String(e),e}if(tr.value){const r={status:{_neq:"archived"}};return e?e._and?{_and:[...e._and,r]}:{_and:[e,r]}:r}return e}()}catch(e){return void S({title:"Filtre invalide",message:"Ton filtre JSON n'est pas valide.",type:"error"})}const r={collection:Ze.value,dryRun:or.value,batchSize:Math.max(1,Math.min(500,Number(sr.value)||100))};e&&(r.filter=e);const a=vr.value,n=Array.from(new Set(er.value));n.length>0&&n.length<a.length&&(r.fields=n),dr.value=!0,console.log("[Module] Envoi du recalcul avec payload:",r);try{const{data:e}=await z.post("/realtime-calc/utils/realtime-calc.recalculate-collection",r);console.log("[Module] Réponse reçue:",e),cr.value=e||null;S({title:"Recalcul",message:e?.message||(e?.success?"Recalcul terminé.":"Recalcul terminé avec des erreurs."),type:e?.success?"success":"warning"})}catch(e){const r=e?.response?.data?.error||e?.message||String(e);S({title:"Erreur recalcul",message:r,type:"error"})}finally{dr.value=!1}}return t(Ze,e=>{if(cr.value=null,lr.value=null,ar.value="",!e)return void(er.value=[]);const r=(ir.value[e]||[]).map(e=>e.champ_cible);er.value=r}),t(nr,()=>{lr.value=null}),s(wr),(e,r)=>{const a=o("v-icon"),n=o("v-button"),l=o("v-progress-circular"),t=o("v-notice"),s=o("v-progress-linear"),z=o("v-select"),S=o("v-textarea"),_r=o("v-input"),zr=o("v-checkbox"),Sr=o("private-view"),Rr=d("tooltip");return i(),c(Sr,{title:"Recalcul des formules"},{headline:u(()=>r[9]||(r[9]=[g("Formules",-1)])),"title-outer:prepend":u(()=>[b(n,{class:"header-icon",rounded:"",disabled:"",icon:"",secondary:""},{default:u(()=>[b(a,{name:"auto_graph"})]),_:1})]),actions:u(()=>[R.value||We.value?f("v-if",!0):y((i(),c(n,{key:0,rounded:"",icon:"",onClick:wr},{default:u(()=>[b(a,{name:"refresh"})]),_:1})),[[Rr,"Recharger"]])]),default:u(()=>[v("div",U,[R.value?(i(),m("div",V,[b(l,{indeterminate:"",size:32}),r[10]||(r[10]=v("span",null,"Chargement des formules…",-1))])):We.value?(i(),c(t,{key:1,type:"danger",icon:"error"},{default:u(()=>[g(p(We.value),1)]),_:1})):(i(),m("div",A,[f(" Result Alert - Top "),cr.value&&!dr.value?(i(),m("div",F,[v("div",{class:h(["result-card-header",cr.value.success?"result-success":"result-warning"])},[v("div",O,[b(a,{name:cr.value.success?"check_circle":"warning",large:""},null,8,["name"])]),v("div",N,[v("h3",j,p(cr.value.message||(cr.value.success?"Recalcul terminé avec succès":"Recalcul terminé avec des erreurs")),1),v("div",M,[v("span",E,[b(a,{name:"storage","x-small":""}),g(" "+p(cr.value.collection),1)]),cr.value.fields&&cr.value.fields.length?(i(),m("span",L,p(cr.value.fields.length)+" champ(s) recalculé(s) ",1)):f("v-if",!0),cr.value.dryRun?(i(),m("span",T,[b(a,{name:"visibility","x-small":""}),r[11]||(r[11]=g(" Dry Run ",-1))])):f("v-if",!0)])])],2),v("div",D,[v("div",q,[v("div",$,[b(a,{name:"check_circle",small:""})]),v("div",J,[r[12]||(r[12]=v("span",{class:"result-stat-label"},"Items traités",-1)),v("span",B,p(cr.value.processed??"–"),1)])]),v("div",G,[v("div",I,[b(a,{name:"edit",small:""})]),v("div",P,[r[13]||(r[13]=v("span",{class:"result-stat-label"},"Items modifiés",-1)),v("span",X,p(cr.value.updated??"–"),1)])]),void 0!==cr.value.total?(i(),m("div",H,[v("div",K,[b(a,{name:"dataset",small:""})]),v("div",Q,[r[14]||(r[14]=v("span",{class:"result-stat-label"},"Total",-1)),v("span",W,p(cr.value.total),1)])])):f("v-if",!0)])])):f("v-if",!0),f(" Progress Bar "),dr.value?(i(),m("div",Y,[r[15]||(r[15]=v("div",{class:"progress-header"},[v("span",{class:"progress-title"},"Recalculation en cours..."),v("span",{class:"progress-status"},"Traitement des données")],-1)),b(s,{indeterminate:""}),v("div",Z,[v("span",null,"Collection: "+p(Ze.value),1),er.value.length?(i(),m("span",ee,p(er.value.length)+" champ(s) sélectionné(s)",1)):f("v-if",!0)])])):f("v-if",!0),f(" Main Content Grid "),v("div",re,[f(" Left: Configuration Form "),v("div",ae,[r[27]||(r[27]=v("div",{class:"card-header"},[v("h3",{class:"card-title"},"Configuration")],-1)),v("div",ne,[v("div",le,[v("div",te,[r[16]||(r[16]=v("div",{class:"select-group-titles"},[v("label",{class:"form-label"},"Collection"),v("span",{class:"form-subtitle"},"Choisissez la source à recalculer")],-1)),ur.value.length?(i(),m("span",se,p(mr.value.length)+" / "+p(ur.value.length),1)):f("v-if",!0)]),y(v("input",{class:"select-search",type:"search","onUpdate:modelValue":r[0]||(r[0]=e=>rr.value=e),disabled:0===ur.value.length,placeholder:"Rechercher une collection..."},null,8,oe),[[x,rr.value,void 0,{trim:!0}]]),b(z,{items:mr.value,disabled:0===ur.value.length,placeholder:"Sélectionnez une collection...",modelValue:Ze.value,"onUpdate:modelValue":r[1]||(r[1]=e=>Ze.value=e)},null,8,["items","disabled","modelValue"]),rr.value&&0===mr.value.length?(i(),m("span",de," Aucune collection ne correspond à cette recherche ")):f("v-if",!0)]),v("div",ce,[r[18]||(r[18]=v("label",{class:"form-label"},"Champs à recalculer",-1)),v("div",ie,[v("div",ue,[v("div",ve,[v("div",me,[v("input",{type:"checkbox",id:"selectAllFields",checked:gr.value,".indeterminate":pr.value,onChange:xr,disabled:!Ze.value||0===vr.value.length||0===br.value.length},null,40,be),r[17]||(r[17]=v("label",{for:"selectAllFields"},"Sélectionner tout",-1))]),vr.value.length?(i(),m("span",ge,p(br.value.length)+" / "+p(vr.value.length),1)):f("v-if",!0)]),y(v("input",{class:"fields-search",type:"search","onUpdate:modelValue":r[2]||(r[2]=e=>ar.value=e),disabled:!Ze.value||0===vr.value.length,placeholder:"Rechercher un champ..."},null,8,pe),[[x,ar.value,void 0,{trim:!0}]])]),Ze.value?0===vr.value.length?(i(),m("div",he," Aucune formule trouvée pour cette collection ")):0===br.value.length?(i(),m("div",ye," Aucun champ ne correspond à cette recherche ")):(i(!0),m(k,{key:3},w(br.value,e=>(i(),m("div",{key:e,class:"field-item",onClick:r=>function(e){const r=er.value.indexOf(e);r>-1?er.value.splice(r,1):er.value.push(e)}(e)},[y(v("input",{type:"checkbox",id:`field_${e}`,value:e,"onUpdate:modelValue":r[3]||(r[3]=e=>er.value=e),onClick:r[4]||(r[4]=C(()=>{},["stop"]))},null,8,ke),[[_,er.value]]),v("label",{for:`field_${e}`},p(e),9,we)],8,xe))),128)):(i(),m("div",fe," Sélectionnez d'abord une collection "))]),r[19]||(r[19]=v("span",{class:"form-hint"},"Laissez vide pour recalculer tous les champs",-1))]),v("div",Ce,[v("div",_e,[r[21]||(r[21]=v("label",{class:"form-label",style:{margin:"0"}},"Filtre (optionnel)",-1)),v("div",ze,[y(v("input",{type:"checkbox",id:"excludeArchived","onUpdate:modelValue":r[5]||(r[5]=e=>tr.value=e),style:{margin:"0"}},null,512),[[_,tr.value]]),r[20]||(r[20]=v("label",{for:"excludeArchived",style:{margin:"0",cursor:"pointer","font-size":"0.75rem",color:"var(--theme--foreground-subdued)"}}," Exclure archivés ",-1))])]),b(S,{modelValue:nr.value,"onUpdate:modelValue":r[6]||(r[6]=e=>nr.value=e),placeholder:'{"status": {"_eq": "published"}}',rows:"2"},null,8,["modelValue"]),r[22]||(r[22]=v("span",{class:"form-hint"},"Filtre JSON pour sélectionner les items à traiter",-1)),lr.value?(i(),m("span",Se,p(lr.value),1)):f("v-if",!0)]),v("div",Re,[r[23]||(r[23]=v("label",{class:"form-label"},"Taille de batch",-1)),b(_r,{modelValue:sr.value,"onUpdate:modelValue":r[7]||(r[7]=e=>sr.value=e),modelModifiers:{number:!0},type:"number",min:1,max:500,placeholder:"100"},null,8,["modelValue"]),r[24]||(r[24]=v("span",{class:"form-hint"},"Nombre d'items traités par lot (recommandé: 100)",-1))]),v("div",Ue,[b(zr,{modelValue:or.value,"onUpdate:modelValue":r[8]||(r[8]=e=>or.value=e),label:"Mode test (Dry Run) - Ne modifie pas les données"},null,8,["modelValue"])]),v("div",Ve,[b(n,{loading:dr.value,disabled:!hr.value,onClick:Cr,large:""},{default:u(()=>[b(a,{name:"play_arrow",left:""}),r[25]||(r[25]=g(" Lancer la recalculation ",-1))]),_:1,__:[25]},8,["loading","disabled"]),b(n,{onClick:kr,disabled:dr.value,secondary:""},{default:u(()=>r[26]||(r[26]=[g(" Réinitialiser ",-1)])),_:1,__:[26]},8,["disabled"])])])]),f(" Right: Stats & Recent Formulas "),v("div",Ae,[f(" Stats Card "),v("div",Fe,[r[31]||(r[31]=v("div",{class:"card-header"},[v("h3",{class:"card-title"},"Statistiques")],-1)),v("div",Oe,[v("div",Ne,[v("div",je,[r[28]||(r[28]=v("div",{class:"stat-label"},"Formulas",-1)),v("div",Me,p(Ye.value.length),1)]),v("div",Ee,[r[29]||(r[29]=v("div",{class:"stat-label"},"Collections",-1)),v("div",Le,p(Object.keys(ir.value).length),1)])]),Ze.value?(i(),m("div",Te,[r[30]||(r[30]=v("div",{class:"info-box-label"},"Collection sélectionnée",-1)),v("div",De,p(Ze.value),1),v("div",qe,p(vr.value.length)+" formule(s) disponible(s)",1)])):f("v-if",!0)])]),f(" Recent Formulas Card "),v("div",$e,[r[32]||(r[32]=v("div",{class:"card-header"},[v("h3",{class:"card-title"},"Formules récentes"),v("span",{class:"badge badge-success"},"Live")],-1)),v("div",Je,[(i(!0),m(k,null,w(fr.value,e=>(i(),m("div",{key:e.id,class:"formula-item",onClick:r=>function(e){rr.value="",Ze.value=e.collection_cible}(e)},[v("div",Ge,[v("div",Ie,p(e.champ_cible),1),v("div",Pe,p(e.collection_cible),1)]),v("div",Xe,p(e.formula),1),v("div",He,[v("span",null,p(e.scope),1)])],8,Be))),128)),0===Ye.value.length?(i(),m("div",Ke," Aucune formule disponible ")):f("v-if",!0)])])])]),f(" Debug: JSON Result "),cr.value?(i(),m("details",Qe,[r[33]||(r[33]=v("summary",null,"Voir la réponse complète (JSON)",-1)),v("pre",null,p(yr.value),1)])):f("v-if",!0)]))])]),_:1})}}};var Ye=a({id:"realtime-recalc-dashboard",name:"Formula Engine",icon:"calculate",routes:[{path:"",component:R(We,[["__scopeId","data-v-21d73cb7"]])}]});export{Ye as default};
