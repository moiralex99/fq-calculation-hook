import{useApi as e,useStores as l,defineModule as a}from"@directus/extensions-sdk";import{ref as n,computed as r,watch as t,onMounted as u,resolveComponent as s,resolveDirective as o,openBlock as c,createBlock as i,withCtx as d,createTextVNode as m,createVNode as v,withDirectives as p,createCommentVNode as f,createElementVNode as g,createElementBlock as y,toDisplayString as h}from"vue";var b=[],_=[];!function(e,l){if(e&&"undefined"!=typeof document){var a,n=!0===l.prepend?"prepend":"append",r=!0===l.singleTag,t="string"==typeof l.container?document.querySelector(l.container):document.getElementsByTagName("head")[0];if(r){var u=b.indexOf(t);-1===u&&(u=b.push(t)-1,_[u]={}),a=_[u]&&_[u][n]?_[u][n]:_[u][n]=s()}else a=s();65279===e.charCodeAt(0)&&(e=e.substring(1)),a.styleSheet?a.styleSheet.cssText+=e:a.appendChild(document.createTextNode(e))}function s(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),l.attributes)for(var a=Object.keys(l.attributes),r=0;r<a.length;r++)e.setAttribute(a[r],l.attributes[a[r]]);var u="prepend"===n?"afterbegin":"beforeend";return t.insertAdjacentElement(u,e),e}}("\n.recalc-module[data-v-1bf34413] {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 1.5rem;\r\n  padding: 1.5rem;\r\n  max-width: 900px;\r\n  margin: auto;\n}\n.recalc-loading[data-v-1bf34413] {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 0.75rem;\r\n  justify-content: center;\r\n  color: var(--theme--foreground-subdued);\n}\n.recalc-card[data-v-1bf34413] {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 1.5rem;\n}\n.recalc-card__header h1[data-v-1bf34413] {\r\n  margin: 0;\r\n  font-size: 1.4rem;\n}\n.recalc-card__header p[data-v-1bf34413] {\r\n  margin: 0;\r\n  color: var(--theme--foreground-subdued);\n}\n.recalc-grid[data-v-1bf34413] {\r\n  display: grid;\r\n  gap: 1rem;\r\n  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));\r\n  align-items: flex-end;\n}\n.recalc-label[data-v-1bf34413] {\r\n  display: block;\r\n  font-weight: 600;\r\n  margin-bottom: 0.5rem;\n}\n.recalc-error[data-v-1bf34413] {\r\n  color: var(--theme--danger);\n}\n.recalc-summary[data-v-1bf34413] {\r\n  white-space: pre-line;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 0.25rem;\n}\n.recalc-actions[data-v-1bf34413] {\r\n  display: flex;\r\n  justify-content: flex-start;\n}\n.recalc-result__details[data-v-1bf34413] {\r\n  margin-top: 0.5rem;\r\n  display: flex;\r\n  flex-wrap: wrap;\r\n  gap: 1rem;\n}\n.recalc-result-json[data-v-1bf34413] {\r\n  background: var(--theme--background-subdued);\r\n  border-radius: 6px;\r\n  padding: 0.75rem 1rem;\n}\n.recalc-result-json pre[data-v-1bf34413] {\r\n  margin-top: 0.75rem;\r\n  overflow-x: auto;\r\n  font-family: var(--theme--font-monospace);\r\n  font-size: 0.85rem;\n}\n.recalc-empty[data-v-1bf34413] {\r\n  margin-bottom: 1rem;\n}\r\n",{});const x={class:"recalc-module"},k={key:0,class:"recalc-loading"},w={key:2,class:"recalc-card"},V={class:"recalc-grid"},j={key:0,class:"recalc-error"},S={key:0},M={key:1},C={class:"recalc-actions"},O={class:"recalc-result__details"},R={key:0},N={key:1},T={key:2},z={key:3,class:"recalc-result-json"};var A=a({id:"realtime-recalc-dashboard",name:"Recalc Formules",icon:"auto_graph",routes:[{path:"",component:((e,l)=>{const a=e.__vccOpts||e;for(const[e,n]of l)a[e]=n;return a})({__name:"module",setup(a){const b=e();let _=({title:e,message:l,type:a})=>{const n=l??"";"error"===a||"danger"===a?console.error(e,n):"warning"===a?console.warn(e,n):console.log(e,n)};try{const e="function"==typeof l?l():null,a=e?.useNotificationsStore?.();a?.add&&(_=({title:e,message:l,type:n})=>a.add({title:e,message:l,text:l,type:n}))}catch(e){}const A=n(!0),q=n(null),E=n([]),F=n(null),U=n([]),J=n(""),B=n(null),$=n(100),I=n(!1),L=n(!1),D=n(null),G=r(()=>{const e={};for(const l of E.value){const a=l.collection_cible;e[a]||(e[a]=[]),e[a].push(l)}return e}),H=r(()=>Object.entries(G.value).map(([e,l])=>({value:e,text:`${e} (${l.length} formule${l.length>1?"s":""})`}))),K=r(()=>{if(!F.value)return[];return(G.value[F.value]||[]).map(e=>e.champ_cible)}),P=r(()=>K.value.map(e=>({value:e,text:e}))),Q=r(()=>Boolean(F.value)&&!L.value),W=r(()=>D.value?JSON.stringify(D.value,null,2):"");async function X(){A.value=!0,q.value=null;try{console.log("[Module] Chargement des formules depuis quartz_formulas...");const{data:e}=await b.get("/items/quartz_formulas",{params:{limit:-1,fields:["id","collection_cible","champ_cible","formula","scope","status"]}});console.log("[Module] Formules reçues:",e),E.value=e?.data||[],console.log("[Module] Nombre de formules:",E.value.length),console.log("[Module] Collections détectées:",Object.keys(G.value)),0===Object.keys(G.value).length?F.value=null:F.value||(F.value=Object.keys(G.value)[0])}catch(e){console.error("[Module] Erreur lors du chargement:",e);const l=e?.response?.data?.errors?.[0]?.message||e?.message||String(e);q.value=l,_({title:"Erreur de chargement",message:l,type:"error"})}finally{A.value=!1}}async function Y(){if(!F.value)return void _({title:"Collection manquante",message:"Choisis une collection à recalculer.",type:"warning"});B.value=null,D.value=null;let e=null;try{e=function(){if(!J.value||!J.value.trim())return null;try{const e=JSON.parse(J.value);return B.value=null,e}catch(e){throw B.value=e?.message||String(e),e}}()}catch(e){return void _({title:"Filtre invalide",message:"Ton filtre JSON n'est pas valide.",type:"error"})}const l={collection:F.value,dryRun:I.value,batchSize:Math.max(1,Math.min(500,Number($.value)||100))};e&&(l.filter=e);const a=K.value,n=Array.from(new Set(U.value));n.length>0&&n.length<a.length&&(l.fields=n),L.value=!0,console.log("[Module] Envoi du recalcul avec payload:",l);try{const{data:e}=await b.post("/realtime-calc/utils/realtime-calc.recalculate-collection",l);console.log("[Module] Réponse reçue:",e),D.value=e||null;_({title:"Recalcul",message:e?.message||(e?.success?"Recalcul terminé.":"Recalcul terminé avec des erreurs."),type:e?.success?"success":"warning"})}catch(e){const l=e?.response?.data?.error||e?.message||String(e);_({title:"Erreur recalcul",message:l,type:"error"})}finally{L.value=!1}}return t(F,e=>{if(D.value=null,B.value=null,!e)return void(U.value=[]);const l=(G.value[e]||[]).map(e=>e.champ_cible);U.value=l}),t(J,()=>{B.value=null}),u(X),(e,l)=>{const a=s("v-icon"),n=s("v-button"),r=s("v-progress-circular"),t=s("v-notice"),u=s("v-select"),b=s("v-input"),_=s("v-checkbox"),E=s("v-textarea"),G=s("private-view"),Z=o("tooltip");return c(),i(G,{title:"Recalcul des formules"},{headline:d(()=>[...l[5]||(l[5]=[m("Formules",-1)])]),"title-outer:prepend":d(()=>[v(n,{class:"header-icon",rounded:"",disabled:"",icon:"",secondary:""},{default:d(()=>[v(a,{name:"auto_graph"})]),_:1})]),actions:d(()=>[A.value||q.value?f("v-if",!0):p((c(),i(n,{key:0,rounded:"",icon:"",onClick:X},{default:d(()=>[v(a,{name:"refresh"})]),_:1})),[[Z,"Recharger"]])]),default:d(()=>[g("div",x,[A.value?(c(),y("div",k,[v(r,{indeterminate:"",size:32}),l[6]||(l[6]=g("span",null,"Chargement des formules…",-1))])):q.value?(c(),i(t,{key:1,type:"danger",icon:"error"},{default:d(()=>[m(h(q.value),1)]),_:1})):(c(),y("div",w,[v(t,{type:"info",icon:"info",class:"recalc-info"},{default:d(()=>[...l[7]||(l[7]=[g("strong",null,"Info :",-1),m(" Le recalcul ne traitera que les ",-1),g("strong",null,"formules locales",-1),m(" (non globales) configurées dans la collection sélectionnée. ",-1)])]),_:1}),0===H.value.length?(c(),i(t,{key:0,type:"warning",icon:"warning",class:"recalc-empty"},{default:d(()=>[...l[8]||(l[8]=[m(" Aucune formule trouvée dans quartz_formulas. ",-1)])]),_:1})):f("v-if",!0),g("section",V,[v(u,{label:"Collection",items:H.value,disabled:0===H.value.length,placeholder:"Sélectionne une collection",modelValue:F.value,"onUpdate:modelValue":l[0]||(l[0]=e=>F.value=e)},null,8,["items","disabled","modelValue"]),v(u,{label:"Champs calculés",items:P.value,modelValue:U.value,"onUpdate:modelValue":l[1]||(l[1]=e=>U.value=e),multiple:"",chips:"",disabled:!F.value||0===P.value.length,placeholder:"Tous les champs"},null,8,["items","modelValue","disabled"]),v(b,{label:"Batch size (1-500)",modelValue:$.value,"onUpdate:modelValue":l[2]||(l[2]=e=>$.value=e),modelModifiers:{number:!0},type:"number",min:1,max:500},null,8,["modelValue"]),v(_,{label:"Mode dry-run (aucune écriture)",modelValue:I.value,"onUpdate:modelValue":l[3]||(l[3]=e=>I.value=e)},null,8,["modelValue"])]),g("section",null,[l[9]||(l[9]=g("label",{class:"recalc-label"},"Filtre JSON Directus (optionnel)",-1)),v(E,{modelValue:J.value,"onUpdate:modelValue":l[4]||(l[4]=e=>J.value=e),placeholder:'{ "status": { "_eq": "published" } }',rows:"5","auto-grow":""},null,8,["modelValue"]),B.value?(c(),y("small",j,h(B.value),1)):f("v-if",!0)]),F.value?(c(),i(t,{key:1,type:"info",icon:"calculate",class:"recalc-summary"},{default:d(()=>[g("span",null,[g("strong",null,h(K.value.length),1),m(" champ(s) calculé(s) détecté(s) dans "+h(F.value)+".",1)]),0===U.value.length||U.value.length===K.value.length?(c(),y("span",S," Tous les champs seront recalculés. ")):(c(),y("span",M,h(U.value.length)+" champ(s) sélectionné(s): "+h(U.value.join(", ")),1))]),_:1})):f("v-if",!0),g("div",C,[v(n,{loading:L.value,disabled:!Q.value,icon:"play_arrow",color:"primary",onClick:Y},{default:d(()=>[...l[10]||(l[10]=[m(" Lancer le recalcul ",-1)])]),_:1},8,["loading","disabled"])]),D.value?(c(),i(t,{key:2,type:D.value.success?"success":"warning",icon:D.value.success?"check_circle":"error",class:"recalc-result"},{default:d(()=>[g("strong",null,h(D.value.message||(D.value.success?"Recalcul terminé.":"Recalcul terminé avec des erreurs.")),1),g("div",O,[g("span",null,"Traités : "+h(D.value.processed??"–"),1),g("span",null,"Mises à jour : "+h(D.value.updated??"–"),1),void 0!==D.value.total?(c(),y("span",R,"Total : "+h(D.value.total),1)):f("v-if",!0),Array.isArray(D.value.fields)&&D.value.fields.length?(c(),y("span",N,"Champs : "+h(D.value.fields.join(", ")),1)):f("v-if",!0),D.value.dryRun?(c(),y("span",T,"Mode dry-run")):f("v-if",!0)])]),_:1},8,["type","icon"])):f("v-if",!0),D.value?(c(),y("details",z,[l[11]||(l[11]=g("summary",null,"Voir la réponse complète",-1)),g("pre",null,h(W.value),1)])):f("v-if",!0)]))])]),_:1})}}},[["__scopeId","data-v-1bf34413"],["__file","module.vue"]])}]});export{A as default};
